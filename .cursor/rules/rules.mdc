---
description: "‚ö†Ô∏è ALWAYS READ THIS FILE FIRST ‚Äî Contains critical git commands (g/d/m/p/pf) and coding conventions"
globs: ["**/*"]
alwaysApply: true
---

# Coding Rules

> üö® **READ THIS ENTIRE FILE AT THE START OF EVERY CONVERSATION.** This contains single-letter git commands (`g`, `d`, `m`, `p`, `pf`) that must be executed immediately when typed.

> ‚ö†Ô∏è **THIS FILE IS COMMITTED TO GIT.** Do not add sensitive data: no emails, URLs, passwords, API keys, or secrets.

## Code Style

### TypeScript
- Use strict mode
- Prefer explicit types over `any`
- Export types from `src/types.ts` for public API
- Internal types stay in their respective files

### React Components
- Functional components only
- All UI components are client-side (`'use client'` is implicit in the package)
- Use `useCallback` and `useMemo` for performance
- Props interfaces defined inline or in same file
- Use `cn()` utility from `src/lib/cn.ts` for conditional classes

### Styling
- Use Tailwind CSS exclusively
- Dark mode: Use `dark:` prefix (relies on host app's theme)
- Use semantic color tokens: `bg-popover`, `text-muted-foreground`, `border-border`, etc.
- Mobile-first: Use responsive prefixes (`md:`, `lg:`) for desktop overrides
- Touch targets: `min-h-[44px] md:min-h-0` for mobile-friendly buttons

### Dropdown Menus
- Container: `bg-popover border border-border rounded-md shadow-lg p-1`
- Items: `px-3 py-2.5 md:px-2 md:py-1.5 min-h-[44px] md:min-h-0 rounded-sm hover:bg-accent cursor-default`
- Destructive: Add `text-destructive` class
- Separator: `<div className="h-px bg-border my-1" />`

## Package Architecture

### Layer Separation
| Layer | Location | Purpose |
|-------|----------|---------|
| Data | `src/data/` | Prisma queries, CRUD operations |
| API | `src/api/` | HTTP handlers, request/response |
| UI | `src/ui/` | React components, hooks, pages |
| AI | `src/ai/` | LLM providers, prompts, generation |
| Lib | `src/lib/` | Utilities, shared helpers |

### Export Structure
- `autoblogger` ‚Äî Server-side: data layer, API handlers
- `autoblogger/ui` ‚Äî Client-side: React components, hooks
- `autoblogger/styles/article` ‚Äî Article layout utilities
- `autoblogger/lib/markdown` ‚Äî Markdown parsing
- `autoblogger/lib/seo` ‚Äî SEO utilities

### File Conventions
- Data layer files match entity names: `posts.ts`, `revisions.ts`, `comments.ts`
- API handlers: one file per resource with all CRUD operations
- UI pages: `WriterDashboard.tsx`, `EditorPage.tsx`, `SettingsPage.tsx`
- Hooks: `use*.ts` pattern in `src/ui/hooks/`

## API Handlers

Pattern for all API handlers:
```typescript
export async function handleResourceAPI(
  req: NextRequest,
  cms: AutobloggerServer,
  session: Session | null,
  path: string,
  onMutate?: (type: string, data: unknown) => Promise<void>
): Promise<Response>
```

- Use `jsonResponse(data, status)` helper
- Check `cms.config.auth.isAdmin(session)` for protected routes
- Call `onMutate` after successful mutations for cache invalidation
- Return proper status codes: 200, 201, 400, 401, 403, 404, 405

## Data Layer

Pattern for data classes:
```typescript
export function createResourceData(prisma: PrismaClient) {
  return {
    findAll: async (options?) => { ... },
    findById: async (id) => { ... },
    create: async (data) => { ... },
    update: async (id, data) => { ... },
    delete: async (id) => { ... },
    count: async (where?) => { ... },
  }
}
```

- Always include `orderBy` for list queries
- Support pagination: `skip`, `take` options
- Include related data via Prisma `include`

## UI Components

### Context
- `DashboardProvider` wraps all UI and provides:
  - `navigate(path)` ‚Äî Internal SPA navigation
  - `apiBasePath` ‚Äî Base URL for API calls
  - `sharedData` ‚Äî Preloaded counts and settings
  - `goBack()` ‚Äî Magic back (history or root)

### Pages
- `WriterDashboard` ‚Äî Post list, AI generation, tabs
- `EditorPage` ‚Äî Tiptap editor, toolbar, metadata
- `SettingsPage` ‚Äî Admin settings sub-pages

### Settings Sub-Pages
Each settings section follows this pattern:
1. Header with `text-lg font-bold` title
2. Card container: `rounded-lg border bg-card shadow-sm`
3. Form fields with `space-y-2` grouping
4. Tables: desktop `hidden md:block`, mobile `md:hidden` with cards

## Don't
- Don't use inline styles
- Don't hardcode URLs or paths (use context)
- Don't import from host app directly
- Don't use `text-sm`, `text-lg` etc. in settings (use semantic tokens)
- Don't create new dropdown patterns (use established classes)

## Do
- Keep components focused and reusable
- Handle loading states with skeletons
- Support both light and dark themes
- Test on mobile (44px touch targets)
- Run `npm run build` before committing

## Git Workflow

> ‚ö†Ô∏è **CRITICAL: Single-letter commands are git workflow triggers.** When the user types just `g`, `d`, `m`, `p`, or `pf` ‚Äî that IS a command. Execute immediately. Don't interpret as casual chat.

| Command | Action |
|---------|--------|
| `g` | Production commit ‚Üí push to `main` |
| `d` | Dev commit ‚Üí push to `dev` |
| `m` | Merge `dev` ‚Üí `main` |
| `p` | Pull current branch |
| `pf` | Force reset to `origin/main` |

> ‚ö†Ô∏è **NEVER push to `main` automatically.** Only push to main when the user EXPLICITLY types "g". After making changes or fixes, commit to `dev` only and WAIT for the user to type "g" before touching main.

### When user types "d" (dev commit)
1. `git status -sb` first ‚Äî review untracked files (`??`), never auto-add `.env*`, `*.save`, `*.bak`
2. `git add -u` (tracked files only) or selectively add, then `git diff --staged --stat`
3. Read modified files for context
4. Review chat history
5. Commit with descriptive message summarizing changes
6. Push to `dev` branch

### When user types "g" (production commit)
**ONLY run this when the user EXPLICITLY types "g".** Never auto-push to main after making fixes.

If on `dev` or another branch:
1. `git stash` (if uncommitted changes)
2. `git checkout main`
3. `git merge dev` (or current branch)
4. Continue with steps below, then `git checkout dev` to return

Steps:
1. **Run `npm run build`** ‚Äî catches TypeScript errors before they fail
2. `git status -sb` ‚Äî review untracked files (`??`), never auto-add `.env*`, `*.save`, `*.bak`
3. `git add -u` (tracked files only) or selectively add, then `git diff --staged --stat`
4. Read modified files for context
5. Review chat history
6. **Update `.cursor/rules/` if significant changes were made:**
   - `rules.mdc` ‚Äî New conventions, patterns, do's/don'ts
   - `context.mdc` ‚Äî New systems, architecture, file structure
7. Commit with comprehensive message
8. `git push origin main`
9. If started on another branch: `git checkout dev && git stash pop`

### When user types "m" (merge dev ‚Üí prod)
1. `git fetch origin && git log --oneline main..dev` to see what's being promoted
2. Review the diff: `git diff main..dev --stat`
3. Review chat history for context on what was built/changed
4. **Update `.cursor/rules/` if significant changes were made**
5. If docs updated: commit on `dev` first, push to `dev`
6. Merge dev into main: `git checkout main && git merge dev`
7. Push to `main`
8. Return to dev branch: `git checkout dev`

### When user types "p" (pull current branch)
1. `git stash` ‚Äî save local changes
2. `git pull origin $(git branch --show-current)`
3. `git stash pop` ‚Äî restore local changes

### When user types "pf" (force reset to main)
1. `git stash` ‚Äî save local changes
2. `git fetch origin main`
3. `git reset --hard origin/main`

Changes are preserved in stash (`git stash list` to see, `git stash pop` to restore)

## Build & Test

Before committing:
1. `npm run build` ‚Äî TypeScript compilation + bundling
2. Check for type errors in output
3. Test in host app if making UI changes

After changes to autoblogger, rebuild in host app:
```bash
# In blog repo
npm run dev  # Will pick up linked package changes
```
