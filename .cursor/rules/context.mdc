---
description: "Project architecture, tech stack, and systems reference"
globs: ["**/*"]
alwaysApply: true
---

# Project Context

> ⚠️ **THIS FILE IS COMMITTED TO GIT.** Do not add sensitive data: no emails, URLs, passwords, API keys, or secrets. Use environment variable references instead.

## Overview

**Autoblogger** — an AI-powered headless CMS that embeds into Next.js applications. Provides a complete writing environment with AI assistance (Claude/GPT), letting users generate, edit, and publish blog posts without leaving their app.

**Core Value:**
- **Embedded CMS**: Runs inside host app at `/writer`, not a separate service
- **AI-First**: Claude and GPT for generating essays, editing, and chat
- **Flexible Publishing**: Posts live in host app's database, can sync to external CMSs

## Tech Stack

| Layer | Technology |
|-------|------------|
| Runtime | Node.js 20+ |
| Framework | Next.js 14/15/16 (App Router) |
| UI | React 18/19 |
| Database | Host app's Prisma client |
| Styling | Tailwind CSS (standalone CSS included) |
| Editor | Tiptap WYSIWYG (markdown sync) |
| AI | Anthropic Claude, OpenAI GPT |
| Build | tsup + Tailwind CLI |

## Project Structure

```
src/
├── ai/                 # AI provider integrations
│   ├── provider.ts     # Anthropic/OpenAI streaming, web search
│   ├── prompts.ts      # System prompts for each mode
│   ├── models.ts       # Model definitions and configuration
│   └── chat.ts         # Chat API handler
├── api/                # API route handlers
│   ├── posts.ts        # CRUD for posts
│   ├── ai.ts           # AI generation endpoints
│   ├── settings.ts     # Settings (general + integrations)
│   └── ...
├── auto-draft/         # RSS feed processing
│   ├── rss.ts          # Feed fetching and parsing
│   ├── runner.ts       # Auto-draft generation logic
│   └── keywords.ts     # Keyword filtering
├── cli/                # `npx autoblogger` commands
│   ├── init.ts         # Project setup wizard
│   └── import.ts       # Markdown file importer
├── data/               # Database access layer
│   ├── posts.ts        # Post queries with destination firing
│   ├── factory.ts      # Generic CRUD factory
│   └── ...
├── destinations/       # External CMS adapters
│   ├── dispatcher.ts   # Manages multiple destinations
│   └── prismic.ts      # Prismic adapter
├── lib/                # Utilities
│   ├── markdown.ts     # Markdown ↔ HTML conversion
│   ├── rich-text.ts    # Markdown → Prismic/Contentful/Sanity
│   ├── comments.ts     # Comment utilities
│   └── ...
├── types/              # TypeScript types
│   ├── config.ts       # Server config (no React)
│   ├── destinations.ts # Destination adapter types
│   └── models.ts       # Database model types
├── ui/                 # React components
│   ├── components/     # Reusable UI components
│   ├── pages/          # Full page components
│   ├── hooks/          # React hooks (useChat, useComments)
│   └── context.tsx     # Dashboard context provider
├── index.ts            # Server exports (no React)
└── server.ts           # createAutoblogger() factory

packages/
└── prismic/            # @autoblogger/prismic package
```

## Key Files

| File | Purpose |
|------|---------|
| `src/server.ts` | Creates autoblogger instance with all data accessors |
| `src/api/index.ts` | Main API router that delegates to handlers |
| `src/data/posts.ts` | Post CRUD with destination dispatch logic |
| `src/destinations/dispatcher.ts` | Fires events to all configured destinations |
| `src/ai/provider.ts` | Streaming responses from Claude/GPT, web search |
| `src/ui/pages/EditorPage.tsx` | Main essay editor with AI integration |
| `src/ui/hooks/useChat.ts` | Chat state management and AI communication |

## Data Flow

### Publishing a Post

```
User clicks "Publish"
    ↓
EditorPage calls PATCH /api/cms/posts/:id { status: 'published' }
    ↓
API handler calls cms.posts.update()
    ↓
posts.ts detects status change to 'published'
    ↓
Fires dispatcher.publish(post) for code-configured destinations
    ↓
Fires fireDynamicPrismicDestination() for DB-configured Prismic
    ↓
Each destination's onPublish() is called
```

### AI Chat Flow

```
User sends message in ChatPanel
    ↓
useChat hook calls POST /api/cms/ai/chat
    ↓
API builds prompt with essay context + mode (ask/agent/plan)
    ↓
If web search enabled, fetches results (OpenAI Responses API)
    ↓
Streams response via SSE
    ↓
ChatPanel updates messages in real-time
    ↓
If agent mode, parses edit commands and applies to editor
```

## Database Models

Key models (defined in host app's Prisma schema):

- **Post**: Main content with title, slug, markdown, status, SEO fields
- **Revision**: Saved snapshots of post content
- **Comment**: Inline comments on posts (threaded)
- **Tag/PostTag**: Categorization
- **AISettings**: Model preferences, templates, rules
- **IntegrationSettings**: External CMS configuration (Prismic, etc.)
- **TopicSubscription**: RSS feed subscriptions for auto-draft
- **NewsItem**: Individual RSS items for processing

## Configuration

Host apps configure via `createAutoblogger()`:

```typescript
const cms = createAutoblogger({
  prisma,                           // Host app's Prisma client
  auth: {
    getSession: () => auth(),
    isAdmin: (s) => s?.user?.role === 'admin',
    canPublish: (s) => ['admin', 'writer'].includes(s?.user?.role),
  },
  ai: {
    anthropicKey: process.env.ANTHROPIC_API_KEY,
    openaiKey: process.env.OPENAI_API_KEY,
  },
  prismic: {                        // Optional
    repository: 'my-repo',
    writeToken: process.env.PRISMIC_WRITE_TOKEN,
  },
  destinations: [myAdapter],        // Optional: Custom destinations
  webhooks: ['https://...'],        // Optional: Webhook URLs
  hooks: {
    beforePublish: async (post) => {},
    afterSave: async (post) => {},
    onSlugChange: async ({ oldSlug, newSlug }) => {},
  },
})
```

## Destinations System

### How It Works
1. **Code-configured**: Passed via `config.destinations[]`, fire on every content change
2. **Dynamic (Prismic)**: Configured via Settings UI, stored in `IntegrationSettings`
3. **Webhooks**: Simple POST to URLs with event payload

### Destination Interface
```typescript
interface Destination {
  name: string
  onPublish(post: Post): Promise<DestinationResult>
  onUnpublish(post: Post): Promise<DestinationResult>
  onDelete(post: Post): Promise<DestinationResult>
}
```

### Prismic Sync Modes
- **Stub mode**: Only syncs UID (slug). Content lives in autoblogger.
- **Full mode**: Syncs complete content as Prismic rich text.

## AI Features

### Chat Modes

| Mode | Purpose |
|------|---------|
| Ask | Q&A about essay or general topics |
| Agent | Direct editing with search/replace commands |
| Plan | Generate outlines that can be expanded |

### Web Search
Uses OpenAI's Responses API with `web_search` tool. For Anthropic models:
1. Extract query from user message
2. Call OpenAI Responses API for search results
3. Include results in context for Claude

### Thinking Mode
Extended thinking for Claude models. Adds `thinking: { type: 'enabled', budget_tokens: 10000 }`.

## UI Architecture

### Component Hierarchy
```
AutobloggerDashboard
└── DashboardProvider (context)
    └── DashboardLayout
        ├── Navbar
        ├── ChatProvider (optional)
        │   └── ChatPanel
        └── Router
            ├── WriterDashboard (/)
            ├── EditorPage (/editor/:slug?)
            └── SettingsPage (/settings/*)
```

### State Management
- **DashboardContext**: Navigation, session, shared data, styles
- **ChatContext**: Messages, streaming state, mode, model selection
- **EditorPage local state**: Post content, saving state, revisions

## Build System

- **tsup**: Bundles TypeScript → JS/MJS with declarations
- **Tailwind**: Generates standalone CSS (no Tailwind required in host app)
- **Exports**: Separate `index.ts` (server-safe) and `ui/index.ts` (React)

## Commands

| Command | Description |
|---------|-------------|
| `npm run build` | Full build (tsup + tailwind) |
| `npm run dev` | Watch mode |
| `yalc push` | Push to local yalc for testing |
| `npm run typecheck` | TypeScript type checking |

## Testing Changes

1. Make changes in autoblogger
2. Run `npm run build`
3. Run `yalc push`
4. In host app: `yalc link autoblogger` (NOT `yalc add`)
5. Test the changes

**CRITICAL: Never use `yalc add`** — it writes `file:.yalc/...` into package.json, which breaks production builds. Always use `yalc link` which creates symlinks without modifying package.json.

## Package Exports

```typescript
// Server (from 'autoblogger')
import { createAutoblogger, runAutoDraft } from 'autoblogger'
import { createDestinationDispatcher } from 'autoblogger'
import type { Destination, DestinationResult } from 'autoblogger'

// UI (from 'autoblogger/ui')
import { AutobloggerDashboard, ChatProvider, ChatPanel } from 'autoblogger/ui'

// Utilities
import { renderMarkdown, htmlToMarkdown } from 'autoblogger/markdown'
import { getSeoValues } from 'autoblogger/seo'
import { markdownToPrismicRichText } from 'autoblogger/rich-text'
```

## Current Version: 0.2.7

Recent additions:
- Prismic integration with Settings UI
- Destinations adapter system
- Rich text converters (Prismic, Contentful, Sanity)
- Web search via OpenAI Responses API
- Extended thinking for Claude
- Post URL pattern configuration
- Mobile UX improvements
