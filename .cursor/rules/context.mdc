# Project Context

> üö® **CRITICAL: See `rules.mdc` for single-letter git commands (`g`, `d`, `m`, `p`, `pf`).** When the user types just one of these letters, execute the git workflow immediately ‚Äî don't treat it as casual chat.

> ‚ö†Ô∏è **THIS FILE IS COMMITTED TO GIT.** Do not add sensitive data: no emails, URLs, passwords, API keys, or secrets.

## Overview

**Autoblogger** ‚Äî A reusable CMS package for Next.js applications. Provides a complete content management system with AI-powered writing, inline comments, revision history, and admin settings. Designed to be embedded in host Next.js apps via catch-all routes.

## Tech Stack

| Layer | Technology |
|----|---|
| Runtime | Node.js 20+ |
| Build | tsup (ESM + CJS dual output) |
| Database | Prisma (uses host app's client) |
| UI | React 18/19 |
| Styling | Tailwind CSS (via host app) |
| Editor | Tiptap WYSIWYG with markdown sync |
| AI | Anthropic SDK + OpenAI SDK |
| Markdown | marked + turndown |

## Package Exports

```typescript
// Server-side (API routes, data layer)
import { createAutoblogger, createAPIHandler } from 'autoblogger'

// Client-side (React dashboard)
import { AutobloggerDashboard } from 'autoblogger/ui'

// Chat components (for standalone use)
import { ChatProvider, useChatContext, ChatPanel, ChatButton } from 'autoblogger/ui'

// Keyboard shortcuts
import { SHORTCUTS, useKeyboard, useDashboardKeyboard, GlobalShortcuts } from 'autoblogger/ui'

// AI model utilities
import { useAIModels, ModelSelector } from 'autoblogger/ui'

// Utilities
import { renderMarkdown, renderMarkdownSanitized, htmlToMarkdown, markdownToHtml, generateSlug, wordCount } from 'autoblogger/markdown'
import { ARTICLE_CLASSES } from 'autoblogger/styles/article'
import { getSeoValues } from 'autoblogger/seo'

// Comment utilities (for advanced integrations)
import { createCommentsClient, CommentMark } from 'autoblogger'

// AI model utilities (server-side)
import { resolveModel, getModelOptions, modelHasNativeSearch } from 'autoblogger'

// Auto-draft
import { runAutoDraft, fetchRssFeeds, filterByKeywords } from 'autoblogger'
```

## Project Structure

```
autoblogger/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ index.ts           # Main server exports: createAutoblogger(), utilities
‚îÇ   ‚îú‚îÄ‚îÄ server.ts          # AutobloggerServer class factory
‚îÇ   ‚îú‚îÄ‚îÄ config.ts          # Full config types (includes React types)
‚îÇ   ‚îú‚îÄ‚îÄ schema.ts          # Prisma schema validation helper
‚îÇ   ‚îú‚îÄ‚îÄ types.ts           # Core TypeScript types (Post, Revision, etc.)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ auto-draft/        # Auto-draft from RSS feeds
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.ts       # Barrel exports
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ runner.ts      # runAutoDraft() orchestration
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rss.ts         # fetchRssFeeds() RSS parsing
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ keywords.ts    # filterByKeywords() article filtering
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ cli/               # CLI tool (npx autoblogger)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.ts       # CLI entry point, command parser
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ init.ts        # `init` command ‚Äî project setup
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ import.ts      # `import` command ‚Äî content migration
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ templates/     # Boilerplate file templates
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cms-config.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api-route.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dashboard-page.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils/         # CLI utilities
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ detect.ts      # Project detection (Next.js, Prisma, etc.)
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ backup.ts      # Pre-change backups
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ prisma-merge.ts # Schema conflict detection + merging
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ tailwind-patch.ts # Tailwind config patching (v3 + v4)
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ css-patch.ts   # globals.css autoblogger import patching
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ prompts.ts     # Interactive prompts + logging
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ types/             # Consolidated type definitions
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.ts       # Barrel exports
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models.ts      # Core model interfaces (Post, Comment, etc.)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ session.ts     # Session interface
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.ts      # Config types + DEFAULT_STYLES
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ editor.ts      # Editor state types
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ data/              # Prisma data layer
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.ts       # Barrel exports
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ factory.ts     # createCrudData() generic CRUD factory
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ posts.ts       # Post CRUD + preview URLs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ revisions.ts   # Revision history + restore
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ comments.ts    # Editor & public comments
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tags.ts        # Tag management + post relations
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ topics.ts      # TopicSubscription CRUD
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ news-items.ts  # RSS news item tracking
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ users.ts       # User CRUD
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ai-settings.ts # AI config singleton
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ api/               # HTTP route handlers
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.ts       # createAPIHandler() + route dispatcher
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ utils.ts       # Shared: jsonResponse, parsePath, requireAdmin/Auth
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ posts.ts       # /posts + /posts/:id/comments
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ revisions.ts   # /revisions + restore
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ comments.ts    # /comments (admin listing)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tags.ts        # /tags CRUD
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ topics.ts      # /topics + /topics/:id/generate
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ users.ts       # /users CRUD (admin only)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ai.ts          # /ai/settings, /ai/generate, /ai/chat
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-history.ts # /chat/history persistence
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ settings.ts    # /settings (integration settings)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ upload.ts      # /upload (image upload)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ admin.ts       # /admin/counts
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ ai/                # AI integration
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.ts       # Barrel exports
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models.ts      # AI_MODELS array with searchModel property
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ provider.ts    # Unified streaming abstraction
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ generate.ts    # Essay generation with URL context
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat.ts        # Chat streaming with modes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ prompts.ts     # Default templates (generate, chat, plan, agent, etc.)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ builders.ts    # buildGeneratePrompt, buildChatPrompt, etc.
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ parse.ts       # parseGeneratedContent (title/subtitle extraction)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ lib/               # Utilities
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cn.ts          # clsx + tailwind-merge
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ format.ts      # formatDate, formatRelativeTime, countWords, truncate
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ markdown.ts    # renderMarkdown, parseMarkdown, htmlToMarkdown, markdownToHtml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ markdown-helpers.ts # Cursor-based text manipulation for markdown mode
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ seo.ts         # getSeoValues (title, description fallbacks)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ comments.ts    # createCommentsClient, permission helpers
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ comment-mark.ts # Tiptap CommentMark extension
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ editor-types.ts # RevisionState, AIState types
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models.ts      # LENGTH_OPTIONS, AIModelOption, DEFAULT_MODELS
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ url-extractor.ts # URL detection + content fetching (Puppeteer/Readability)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ styles/            # Style exports
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ article.ts     # ARTICLE_CLASSES, ARTICLE_LAYOUT
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ autoblogger.css # Complete theme CSS (colors, prose, editor)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ preset.js      # Tailwind preset (ab- prefixed tokens)
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ ui/                # React components
‚îÇ       ‚îú‚îÄ‚îÄ index.ts       # UI barrel exports
‚îÇ       ‚îú‚îÄ‚îÄ dashboard.tsx  # AutobloggerDashboard wrapper
‚îÇ       ‚îú‚îÄ‚îÄ context.tsx    # DashboardProvider + hooks
‚îÇ       ‚îú‚îÄ‚îÄ types.ts       # CustomFieldConfig, CustomFieldProps
‚îÇ       ‚îú‚îÄ‚îÄ shortcuts.ts   # SHORTCUTS constant for keyboard shortcuts
‚îÇ       ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ pages/         # Page components
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ WriterDashboard.tsx  # Post list + AI generation
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ EditorPage.tsx       # Tiptap editor + metadata
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ SettingsPage.tsx     # Admin settings subpages
‚îÇ       ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ components/    # Shared components
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ Navbar.tsx
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ TiptapEditor.tsx
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ EditorToolbar.tsx
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ CommentsPanel.tsx
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ CommentThread.tsx
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ ChatPanel.tsx        # AI chat sidebar with mode selector
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ ChatButton.tsx       # Floating chat toggle button
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ TagsSection.tsx
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ ModelSelector.tsx
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ ControlButton.tsx
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ RevisionHistoryDropdown.tsx
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ Skeleton.tsx         # Skeleton, SkeletonText, SkeletonButton, SkeletonCard, SkeletonTableRow
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ Dropdown.tsx         # Reusable dropdown menu
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ Form.tsx             # Form field components
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ SettingsListPage.tsx # Generic admin list page
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ ThemeProvider.tsx    # next-themes provider wrapper
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ ThemeToggle.tsx      # Light/dark mode toggle
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ GlobalShortcuts.tsx  # Global keyboard shortcuts
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ Icons.tsx            # Custom icon components
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ toolbar/
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ index.ts
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ ToolbarButton.tsx
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ FormatButtons.tsx
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ BlockButtons.tsx
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ MediaButtons.tsx
‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ HistoryButtons.tsx
‚îÇ       ‚îÇ
‚îÇ       ‚îî‚îÄ‚îÄ hooks/
‚îÇ           ‚îú‚îÄ‚îÄ useComments.ts    # Comment state + CRUD
‚îÇ           ‚îú‚îÄ‚îÄ useChat.tsx       # ChatProvider + useChatContext + modes
‚îÇ           ‚îú‚îÄ‚îÄ useAIModels.ts    # AI model fetching hook
‚îÇ           ‚îî‚îÄ‚îÄ useKeyboard.ts    # Keyboard shortcuts
‚îÇ
‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îî‚îÄ‚îÄ schema.prisma      # Reference schema for host apps
‚îÇ
‚îú‚îÄ‚îÄ tsconfig.json
‚îú‚îÄ‚îÄ tsup.config.ts         # Dual ESM/CJS build config
‚îî‚îÄ‚îÄ package.json
```

## Database Schema

The package expects these Prisma models in the host app:

### Core Models

```prisma
model Post {
  id          String    @id @default(uuid())
  title       String
  subtitle    String?
  slug        String    @unique
  markdown    String
  status      String    @default("draft") // draft, published, suggested, deleted
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  // SEO fields
  seoTitle       String?
  seoDescription String?
  seoKeywords    String?
  noIndex        Boolean  @default(false)
  ogImage        String?

  // Preview
  previewToken  String?   @unique
  previewExpiry DateTime?

  // Relations
  revisions Revision[]
  tags      PostTag[]
  comments  Comment[]
  newsItem  NewsItem?

  // Auto-draft
  sourceUrl String?
  topicId   String?
  topic     TopicSubscription? @relation(...)
}

model Revision {
  id        String   @id @default(uuid())
  postId    String
  post      Post     @relation(...)
  title     String?
  subtitle  String?
  markdown  String
  createdAt DateTime @default(now())
}

model Comment {
  id         String    @id @default(uuid())
  postId     String
  post       Post      @relation(...)
  userId     String?
  user       User?     @relation(...)
  quotedText String    @default("")  // Highlighted text snapshot
  content    String
  parentId   String?                  // Single-level replies
  parent     Comment?  @relation("Replies", ...)
  replies    Comment[] @relation("Replies")
  resolved   Boolean   @default(false)
  deletedAt  DateTime?                // Soft delete
  approved   Boolean   @default(true) // Legacy for public comments
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}

model User {
  id        String    @id @default(uuid())
  email     String    @unique
  name      String?
  role      String    @default("writer") // admin, writer, drafter
  createdAt DateTime  @default(now())
  comments  Comment[]
}

model Tag {
  id        String    @id @default(uuid())
  name      String    @unique
  createdAt DateTime  @default(now())
  posts     PostTag[]
}

model PostTag {
  id        String   @id @default(uuid())
  postId    String
  tagId     String
  post      Post     @relation(...)
  tag       Tag      @relation(...)
  createdAt DateTime @default(now())
  @@unique([postId, tagId])
}
```

### AI & Integration Models

```prisma
model AISettings {
  id                   String   @id @default("default")
  rules                String   @default("")
  chatRules            String   @default("")
  rewriteRules         String?
  autoDraftRules       String?
  planRules            String?
  defaultModel         String   @default("claude-sonnet")
  autoDraftWordCount   Int      @default(800)
  generateTemplate     String?
  chatTemplate         String?
  rewriteTemplate      String?
  autoDraftTemplate    String?
  planTemplate         String?
  expandPlanTemplate   String?
  agentTemplate        String?  // Template for agent mode (direct editing)
  anthropicKey         String?  // API key stored in DB (optional, env var fallback)
  openaiKey            String?  // API key stored in DB (optional, env var fallback)
  updatedAt            DateTime @updatedAt
}

model IntegrationSettings {
  id               String   @id @default("default")
  autoDraftEnabled Boolean  @default(false)
  postUrlPattern   String   @default("/e/{slug}")  // Pattern for post URLs
  updatedAt        DateTime @updatedAt
}

model TopicSubscription {
  id               String    @id @default(uuid())
  name             String
  keywords         String    // JSON array
  rssFeeds         String    // JSON array
  isActive         Boolean   @default(true)
  useKeywordFilter Boolean   @default(true)
  frequency        String    @default("daily")
  maxPerPeriod     Int       @default(3)
  essayFocus       String?
  lastRunAt        DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  posts            Post[]
  newsItems        NewsItem[]
}

model NewsItem {
  id          String            @id @default(uuid())
  topicId     String
  topic       TopicSubscription @relation(...)
  url         String            @unique
  title       String
  summary     String?
  publishedAt DateTime?
  status      String            @default("pending") // pending, generated, skipped
  postId      String?           @unique
  post        Post?             @relation(...)
  createdAt   DateTime          @default(now())
}
```

## Key Systems

### CLI Tool

The CLI (`npx autoblogger`) automates project setup:

```bash
npx autoblogger init          # Interactive setup
npx autoblogger init --yes    # Non-interactive with defaults
npx autoblogger import ./posts  # Import markdown content
```

**Init Process:**
1. Detect project (Next.js version, Prisma schema, Tailwind config)
2. Check for model name conflicts
3. Merge Prisma schema (adds 11 models)
4. Create boilerplate files (lib/cms.ts, API route, dashboard page)
5. Patch Tailwind config (v3 JS/TS or v4 CSS)
6. Run migration + generate
7. Optionally import existing content

**Files Created:**
- `lib/cms.ts` ‚Äî CMS configuration
- `app/api/cms/[...path]/route.ts` ‚Äî API catch-all route
- `app/writer/[[...path]]/page.tsx` ‚Äî Dashboard page

### URL Content Extraction

The `url-extractor.ts` module fetches article content from URLs:

```typescript
import { extractAndFetchUrls, buildUrlContext } from './lib/url-extractor'

// Extract URLs from text and fetch their content
const fetched = await extractAndFetchUrls(userPrompt)
const context = buildUrlContext(fetched)  // XML format for AI prompts
```

**Features:**
- Detects URLs with/without protocol (`https://`, `www.`, bare domains)
- Uses Puppeteer for JS-rendered pages (auto-detects serverless vs local)
- Falls back to simple HTTP fetch + Mozilla Readability
- Limits content to ~4000 chars to avoid token bloat
- Returns title + cleaned text content

### Host App Integration

The package is mounted via catch-all routes in the host app:

```typescript
// app/api/cms/[...path]/route.ts
import { createAutoblogger, createAPIHandler } from 'autoblogger'
import { prisma } from '@/lib/db'
import { auth } from '@/lib/auth'

const cms = createAutoblogger({
  prisma,
  auth: {
    getSession: () => auth(),
    isAdmin: (session) => session?.user?.role === 'admin',
    canPublish: (session) => ['admin', 'writer'].includes(session?.user?.role),
  },
  ai: {
    anthropicKey: process.env.ANTHROPIC_API_KEY,
    openaiKey: process.env.OPENAI_API_KEY,
  },
  // Optional: Lifecycle hooks
  hooks: {
    beforePublish: async (post) => { /* validate before publishing */ },
    afterSave: async (post) => { /* trigger revalidation, etc. */ },
    onAutoDraftPostCreate: (article, essay) => ({ customField: 'value' }),  // Add extra fields to auto-drafted posts
  },
})

const handler = createAPIHandler(cms, { basePath: '/api/cms' })

export { handler as GET, handler as POST, handler as PATCH, handler as DELETE }
```

```typescript
// app/(dashboard)/writer/[[...path]]/page.tsx
import { AutobloggerDashboard } from 'autoblogger/ui'

export default async function WriterPage({ params }) {
  const session = await auth()
  return (
    <AutobloggerDashboard
      apiBasePath="/api/cms"
      session={session}
      basePath="/writer"
    />
  )
}
```

### Host App Requirements

**CSS Import** ‚Äî Required for prose/markdown styling:
```css
/* app/globals.css */
@import 'autoblogger/styles/autoblogger.css';

@tailwind base;
@tailwind components;
@tailwind utilities;
```

**Tailwind Content** ‚Äî Include autoblogger in content config:
```javascript
content: [
  './node_modules/autoblogger/dist/**/*.{js,mjs}',
]
```

**ChatMessage Model** ‚Äî Required for chat history persistence:
```prisma
model ChatMessage {
  id        String   @id @default(uuid())
  role      String
  content   String
  createdAt DateTime @default(now())
  @@index([createdAt])
}
```

### Navigation System

Internal SPA navigation via `DashboardContext`:
- `navigate(path)` ‚Äî Push to history, update URL, render new page
- `goBack()` ‚Äî Pop history or navigate to root
- `currentPath` ‚Äî Current internal path
- History depth tracking for proper back button behavior

### Routes

| Path | Component | Description |
|------|-----------|-------------|
| `/` | WriterDashboard | Post list, AI generation, suggested posts |
| `/editor` | EditorPage | New post editor |
| `/editor/:slug` | EditorPage | Edit existing post |
| `/settings` | SettingsPage | Settings overview with counts |
| `/settings/users` | SettingsPage | User management |
| `/settings/ai` | SettingsPage | AI rules and templates |
| `/settings/tags` | SettingsPage | Tag management |
| `/settings/topics` | SettingsPage | RSS topic subscriptions |
| `/settings/posts` | SettingsPage | All posts admin view |
| `/settings/revisions` | SettingsPage | Revision history |
| `/settings/revisions/:id` | SettingsPage | Revision detail + restore |
| `/settings/comments` | SettingsPage | Comment moderation |

### AI Models

Defined in `src/ai/models.ts`:
```typescript
export const AI_MODELS: AIModel[] = [
  { id: 'claude-sonnet', name: 'Sonnet 4.5', provider: 'anthropic', modelId: 'claude-sonnet-4-5-20250929', searchModel: null },
  { id: 'claude-opus', name: 'Opus 4.5', provider: 'anthropic', modelId: 'claude-opus-4-5-20251101', searchModel: null },
  { id: 'gpt-5.2', name: 'GPT-5.2', provider: 'openai', modelId: 'gpt-5.2', searchModel: 'native' },
  { id: 'gpt-5-mini', name: 'GPT-5 Mini', provider: 'openai', modelId: 'gpt-5-mini', searchModel: 'native' },
]
```

`searchModel` property:
- `null` ‚Äî Claude models use 2-call flow (search query first, then generate)
- `'native'` ‚Äî GPT models use native tools-based web search

### Chat Modes

The chat system (`useChat.tsx`) supports multiple modes:
- `ask` ‚Äî Default chat mode, answers questions about essay
- `agent` ‚Äî Direct editing mode, AI outputs `:::edit` blocks with JSON commands
- `plan` ‚Äî Outline mode, generates structured plan wrapped in `<plan>` tags
- `search` ‚Äî Research mode, fact-finding without essay generation

Toggle modes via dropdown in ChatPanel or keyboard shortcut **Cmd/Ctrl + Shift + A**.

### Comments System

- **Inline comments**: Tiptap `CommentMark` extension highlights text
- **Panel**: `CommentsPanel` slides in from right (full-screen on mobile)
- **Thread**: `CommentThread` renders comment with nested replies
- **API**: `/posts/:id/comments` CRUD with resolve/unresolve
- **Deep linking**: `?comment=:id` URL param highlights and scrolls to comment

### Editor System

`EditorPage.tsx` provides:
- Tiptap WYSIWYG with markdown sync
- Markdown mode toggle (raw textarea)
- Auto-save drafts (3s debounce)
- Revision history with preview and restore
- AI generation from URL params (`?idea=...&model=...&length=...`)
- Inline comment highlighting
- Custom fields support via `fields` config
- SEO metadata editing

### AI Prompt Templates

Templates use `{{PLACEHOLDER}}` syntax. Defined in `src/ai/prompts.ts`:

| Template | Placeholders | Purpose |
|----------|--------------|---------|
| `DEFAULT_GENERATE_TEMPLATE` | `{{RULES}}`, `{{WORD_COUNT}}` | Essay generation |
| `DEFAULT_CHAT_TEMPLATE` | `{{CHAT_RULES}}`, `{{ESSAY_CONTEXT}}` | Chat conversations |
| `DEFAULT_REWRITE_TEMPLATE` | `{{REWRITE_RULES}}` | Text improvement |
| `DEFAULT_PLAN_TEMPLATE` | `{{PLAN_RULES}}`, `{{STYLE_EXAMPLES}}` | Outline generation |
| `DEFAULT_EXPAND_PLAN_TEMPLATE` | `{{RULES}}`, `{{STYLE_EXAMPLES}}`, `{{PLAN}}` | Plan to essay |
| `DEFAULT_AUTO_DRAFT_TEMPLATE` | `{{AUTO_DRAFT_RULES}}`, `{{RULES}}`, `{{AUTO_DRAFT_WORD_COUNT}}` | RSS auto-draft |
| `DEFAULT_AGENT_TEMPLATE` | (none, appended to chat) | Agent mode instructions |

Builders: `buildGeneratePrompt()`, `buildChatPrompt()`, `buildAgentChatPrompt()`, `buildPlanPrompt()`, `buildExpandPlanPrompt()`, `buildRewritePrompt()`, `buildAutoDraftPrompt()`

### Agent Mode (Direct Editing)

Agent mode allows AI to directly edit essays. Edit commands use JSON in `:::edit` blocks:

```
:::edit
{"type": "replace_section", "find": "exact text", "replace": "new text"}
:::
```

Command types:
- `replace_section` ‚Äî Find and replace specific text
- `replace_all` ‚Äî Replace entire essay (title, subtitle, markdown)
- `insert` ‚Äî Insert text (position: before, after, start, end)
- `delete` ‚Äî Remove text

Template is customizable via Settings ‚Üí AI ‚Üí Agent Mode Template.

Keyboard shortcut: **Cmd/Ctrl + Shift + A** toggles agent/ask mode.

### Chat History Persistence

Chat messages are persisted via `/api/cms/chat/history` API:
- `GET` ‚Äî Fetch all messages (last 50, chronological order)
- `POST` ‚Äî Save a new message
- `DELETE` ‚Äî Clear all messages

History is loaded on mount via `ChatProvider` and messages are saved after each exchange. The `ChatMessage` Prisma model stores role + content + timestamp.

### Keyboard Shortcuts

Defined in `src/ui/shortcuts.ts` and used with `useKeyboard()` hook:

| Shortcut | Action |
|----------|--------|
| Cmd+. | Toggle theme (light/dark) |
| Cmd+/ | Toggle view (essay‚Üîeditor, home‚Üîwriter) |
| Cmd+; | Toggle settings |
| Cmd+K | Open/close chat panel |
| Cmd+Shift+A | Toggle Ask/Agent mode |
| N | New article (not in input fields) |
| Escape | Go back to writer |
| ‚Üê/‚Üí | Navigate posts (not in input fields) |

## API Routes

| Path | Methods | Description |
|---|---|----|
| `/posts` | GET, POST | List/create posts |
| `/posts/:id` | GET, PATCH, DELETE | Single post CRUD |
| `/posts/:id/comments` | GET, POST | Editor comments for post |
| `/posts/:id/comments/:commentId` | PATCH, DELETE | Update/delete comment |
| `/posts/:id/comments/:commentId/resolve` | POST | Toggle resolve |
| `/posts/:id/comments/resolve-all` | POST | Resolve all open comments |
| `/revisions` | GET | List revisions (paginated) |
| `/revisions/:id` | GET, DELETE | Single revision |
| `/revisions/:id/restore` | POST | Restore revision |
| `/comments` | GET, POST | Admin comment listing |
| `/comments/:id/approve` | PATCH | Approve comment |
| `/tags` | GET, POST | List/create tags |
| `/tags/:id` | PATCH, DELETE | Update/delete tag |
| `/topics` | GET, POST | List/create topics |
| `/topics/:id` | GET, PATCH, DELETE | Single topic |
| `/topics/:id/generate` | POST | Trigger topic generation |
| `/users` | GET, POST | List/create users |
| `/users/:id` | GET, PATCH, DELETE | Single user |
| `/ai/settings` | GET, PATCH | AI configuration |
| `/ai/generate` | POST | Generate essay (streaming SSE) |
| `/ai/chat` | POST | Chat streaming (modes: ask, agent, plan, search) |
| `/chat/history` | GET, POST, DELETE | Chat history persistence + clear |
| `/settings` | GET, PATCH | Integration settings |
| `/upload` | POST | Image upload |
| `/admin/counts` | GET | Dashboard counts |

## Commands

### Development

| Command | Description |
|---|----|
| `npm run build` | Build package (ESM + CJS + types) |
| `npm run dev` | Watch mode for development |
| `npm run typecheck` | TypeScript check |
| `npm run lint` | ESLint check |

### CLI

| Command | Description |
|---|----|
| `npx autoblogger init` | Set up Autoblogger in a Next.js project |
| `npx autoblogger init --yes` | Non-interactive setup with defaults |
| `npx autoblogger init --dry-run` | Preview changes without writing |
| `npx autoblogger import <path>` | Import markdown/MDX content |
| `npx autoblogger import <path> --status=published` | Import as published |

## CI/CD

### GitHub Actions: Auto-publish to npm

Located at `.github/workflows/publish.yml`. Triggers on every push to `main`:

1. Checks out code and sets up Node.js 20
2. Installs dependencies and builds
3. **Auto-bumps patch version** if current version matches npm
4. Commits version bump and pushes
5. Publishes to npm
6. Skips version bump commits to prevent infinite loops

To release a new version:
1. Push changes to `main`
2. GitHub Actions automatically bumps version and publishes to npm

For manual version control (minor/major bumps):
1. Run `npm version minor` or `npm version major` locally
2. Commit and push ‚Äî workflow will publish without bumping

## Build Output

```
dist/
‚îú‚îÄ‚îÄ index.js          # CJS main entry
‚îú‚îÄ‚îÄ index.mjs         # ESM main entry
‚îú‚îÄ‚îÄ index.d.ts        # TypeScript declarations
‚îú‚îÄ‚îÄ ui.js             # CJS UI components
‚îú‚îÄ‚îÄ ui.mjs            # ESM UI components
‚îú‚îÄ‚îÄ ui.d.ts           # UI declarations
‚îú‚îÄ‚îÄ cli/
‚îÇ   ‚îî‚îÄ‚îÄ index.js      # CLI entry (npx autoblogger)
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ markdown.js/mjs/d.ts
‚îÇ   ‚îî‚îÄ‚îÄ seo.js/mjs/d.ts
‚îî‚îÄ‚îÄ styles/
    ‚îú‚îÄ‚îÄ article.js/mjs
    ‚îî‚îÄ‚îÄ preset.js     # Tailwind preset (copied)
```

## Development Workflow

1. Make changes in `src/`
2. Run `npm run build` in autoblogger
3. Changes are immediately available in linked host apps
4. Test in host app's dev server
5. Commit with `d` for dev, `g` for production

### Local Linking

For local development, link autoblogger to host projects:

```bash
# In autoblogger directory (creates global symlink)
npm link

# In host project (e.g., sample-blog, blog)
npm link autoblogger
```

Linked projects:
- `/Users/hunter/Local Documents/Code/sample-blog` ‚Äî Sample blog for testing
- `/Users/hunter/Local Documents/Code/blog` ‚Äî Production blog

After making changes, run `npm run build` in autoblogger ‚Äî changes are immediately reflected in linked projects via symlink.

**Note:** Running `npm install` in a linked project may break the link. Re-run `npm link autoblogger` to restore.
