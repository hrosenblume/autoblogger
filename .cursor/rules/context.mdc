# Project Context

> ðŸš¨ **CRITICAL: See `rules.mdc` for single-letter git commands (`g`, `d`, `m`, `p`, `pf`).** When the user types just one of these letters, execute the git workflow immediately â€” don't treat it as casual chat.

> âš ï¸ **THIS FILE IS COMMITTED TO GIT.** Do not add sensitive data: no emails, URLs, passwords, API keys, or secrets.

## Overview

**Autoblogger** â€” A reusable CMS package for Next.js applications. Provides a complete content management system with AI-powered writing, inline comments, revision history, and admin settings. Designed to be embedded in host Next.js apps via catch-all routes.

## Tech Stack

| Layer | Technology |
|----|---|
| Runtime | Node.js 20+ |
| Build | tsup (ESM + CJS dual output) |
| Database | Prisma (uses host app's client) |
| UI | React 18/19 |
| Styling | Tailwind CSS (via host app) |
| Editor | Tiptap WYSIWYG with markdown sync |
| AI | Anthropic SDK + OpenAI SDK |
| Markdown | marked + turndown |

## Package Exports

```typescript
// Server-side (API routes, data layer)
import { createAutoblogger, createAPIHandler } from 'autoblogger'

// Client-side (React dashboard)
import { AutobloggerDashboard } from 'autoblogger/ui'

// Chat components (for standalone use)
import { ChatProvider, useChatContext, ChatPanel, ChatButton } from 'autoblogger/ui'

// Utilities
import { renderMarkdown, htmlToMarkdown, markdownToHtml } from 'autoblogger/markdown'
import { ARTICLE_CLASSES } from 'autoblogger/styles/article'
import { getSeoValues } from 'autoblogger/seo'

// Comment utilities (for advanced integrations)
import { createCommentsClient, CommentMark } from 'autoblogger'

// Auto-draft
import { runAutoDraft, fetchRssFeeds, filterByKeywords } from 'autoblogger'
```

## Project Structure

```
autoblogger/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts           # Main server exports: createAutoblogger(), utilities
â”‚   â”œâ”€â”€ server.ts          # AutobloggerServer class factory
â”‚   â”œâ”€â”€ config.ts          # Full config types (includes React types)
â”‚   â”œâ”€â”€ schema.ts          # Prisma schema validation helper
â”‚   â”œâ”€â”€ types.ts           # Core TypeScript types (Post, Revision, etc.)
â”‚   â”‚
â”‚   â”œâ”€â”€ auto-draft/        # Auto-draft from RSS feeds
â”‚   â”‚   â”œâ”€â”€ index.ts       # Barrel exports
â”‚   â”‚   â”œâ”€â”€ runner.ts      # runAutoDraft() orchestration
â”‚   â”‚   â”œâ”€â”€ rss.ts         # fetchRssFeeds() RSS parsing
â”‚   â”‚   â””â”€â”€ keywords.ts    # filterByKeywords() article filtering
â”‚   â”‚
â”‚   â”œâ”€â”€ cli/               # CLI tool (npx autoblogger)
â”‚   â”‚   â”œâ”€â”€ index.ts       # CLI entry point, command parser
â”‚   â”‚   â”œâ”€â”€ init.ts        # `init` command â€” project setup
â”‚   â”‚   â”œâ”€â”€ import.ts      # `import` command â€” content migration
â”‚   â”‚   â”œâ”€â”€ templates/     # Boilerplate file templates
â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ cms-config.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ api-route.ts
â”‚   â”‚   â”‚   â””â”€â”€ dashboard-page.ts
â”‚   â”‚   â””â”€â”€ utils/         # CLI utilities
â”‚   â”‚       â”œâ”€â”€ detect.ts      # Project detection (Next.js, Prisma, etc.)
â”‚   â”‚       â”œâ”€â”€ backup.ts      # Pre-change backups
â”‚   â”‚       â”œâ”€â”€ prisma-merge.ts # Schema conflict detection + merging
â”‚   â”‚       â”œâ”€â”€ tailwind-patch.ts # Tailwind config patching (v3 + v4)
â”‚   â”‚       â””â”€â”€ prompts.ts     # Interactive prompts + logging
â”‚   â”‚
â”‚   â”œâ”€â”€ types/             # Consolidated type definitions
â”‚   â”‚   â”œâ”€â”€ index.ts       # Barrel exports
â”‚   â”‚   â”œâ”€â”€ models.ts      # Core model interfaces (Post, Comment, etc.)
â”‚   â”‚   â”œâ”€â”€ session.ts     # Session interface
â”‚   â”‚   â”œâ”€â”€ config.ts      # Config types + DEFAULT_STYLES
â”‚   â”‚   â””â”€â”€ editor.ts      # Editor state types
â”‚   â”‚
â”‚   â”œâ”€â”€ data/              # Prisma data layer
â”‚   â”‚   â”œâ”€â”€ index.ts       # Barrel exports
â”‚   â”‚   â”œâ”€â”€ factory.ts     # createCrudData() generic CRUD factory
â”‚   â”‚   â”œâ”€â”€ posts.ts       # Post CRUD + preview URLs
â”‚   â”‚   â”œâ”€â”€ revisions.ts   # Revision history + restore
â”‚   â”‚   â”œâ”€â”€ comments.ts    # Editor & public comments
â”‚   â”‚   â”œâ”€â”€ tags.ts        # Tag management + post relations
â”‚   â”‚   â”œâ”€â”€ topics.ts      # TopicSubscription CRUD
â”‚   â”‚   â”œâ”€â”€ news-items.ts  # RSS news item tracking
â”‚   â”‚   â”œâ”€â”€ users.ts       # User CRUD
â”‚   â”‚   â””â”€â”€ ai-settings.ts # AI config singleton
â”‚   â”‚
â”‚   â”œâ”€â”€ api/               # HTTP route handlers
â”‚   â”‚   â”œâ”€â”€ index.ts       # createAPIHandler() + route dispatcher
â”‚   â”‚   â”œâ”€â”€ utils.ts       # Shared: jsonResponse, parsePath, requireAdmin/Auth
â”‚   â”‚   â”œâ”€â”€ posts.ts       # /posts + /posts/:id/comments
â”‚   â”‚   â”œâ”€â”€ revisions.ts   # /revisions + restore
â”‚   â”‚   â”œâ”€â”€ comments.ts    # /comments (admin listing)
â”‚   â”‚   â”œâ”€â”€ tags.ts        # /tags CRUD
â”‚   â”‚   â”œâ”€â”€ topics.ts      # /topics + /topics/:id/generate
â”‚   â”‚   â”œâ”€â”€ users.ts       # /users CRUD (admin only)
â”‚   â”‚   â”œâ”€â”€ ai.ts          # /ai/settings, /ai/generate, /ai/chat
â”‚   â”‚   â”œâ”€â”€ chat-history.ts # /chat/history persistence
â”‚   â”‚   â”œâ”€â”€ settings.ts    # /settings (integration settings)
â”‚   â”‚   â”œâ”€â”€ upload.ts      # /upload (image upload)
â”‚   â”‚   â””â”€â”€ admin.ts       # /admin/counts
â”‚   â”‚
â”‚   â”œâ”€â”€ ai/                # AI integration
â”‚   â”‚   â”œâ”€â”€ index.ts       # Barrel exports
â”‚   â”‚   â”œâ”€â”€ models.ts      # AI_MODELS array with searchModel property
â”‚   â”‚   â”œâ”€â”€ provider.ts    # Unified streaming abstraction
â”‚   â”‚   â”œâ”€â”€ generate.ts    # Essay generation with URL context
â”‚   â”‚   â”œâ”€â”€ chat.ts        # Chat streaming with modes
â”‚   â”‚   â”œâ”€â”€ prompts.ts     # Default templates (generate, chat, plan, agent, etc.)
â”‚   â”‚   â”œâ”€â”€ builders.ts    # buildGeneratePrompt, buildChatPrompt, etc.
â”‚   â”‚   â””â”€â”€ parse.ts       # parseGeneratedContent (title/subtitle extraction)
â”‚   â”‚
â”‚   â”œâ”€â”€ lib/               # Utilities
â”‚   â”‚   â”œâ”€â”€ cn.ts          # clsx + tailwind-merge
â”‚   â”‚   â”œâ”€â”€ format.ts      # formatDate, formatRelativeTime, countWords, truncate
â”‚   â”‚   â”œâ”€â”€ markdown.ts    # renderMarkdown, parseMarkdown, htmlToMarkdown, markdownToHtml
â”‚   â”‚   â”œâ”€â”€ markdown-helpers.ts # Cursor-based text manipulation for markdown mode
â”‚   â”‚   â”œâ”€â”€ seo.ts         # getSeoValues (title, description fallbacks)
â”‚   â”‚   â”œâ”€â”€ comments.ts    # createCommentsClient, permission helpers
â”‚   â”‚   â”œâ”€â”€ comment-mark.ts # Tiptap CommentMark extension
â”‚   â”‚   â”œâ”€â”€ editor-types.ts # RevisionState, AIState types
â”‚   â”‚   â”œâ”€â”€ models.ts      # LENGTH_OPTIONS, AIModelOption, DEFAULT_MODELS
â”‚   â”‚   â””â”€â”€ url-extractor.ts # URL detection + content fetching (Puppeteer/Readability)
â”‚   â”‚
â”‚   â”œâ”€â”€ styles/            # Style exports
â”‚   â”‚   â”œâ”€â”€ article.ts     # ARTICLE_CLASSES, ARTICLE_LAYOUT
â”‚   â”‚   â”œâ”€â”€ autoblogger.css # Complete theme CSS (colors, prose, editor)
â”‚   â”‚   â””â”€â”€ preset.js      # Tailwind preset (ab- prefixed tokens)
â”‚   â”‚
â”‚   â””â”€â”€ ui/                # React components
â”‚       â”œâ”€â”€ index.ts       # UI barrel exports
â”‚       â”œâ”€â”€ dashboard.tsx  # AutobloggerDashboard wrapper
â”‚       â”œâ”€â”€ context.tsx    # DashboardProvider + hooks
â”‚       â”œâ”€â”€ types.ts       # CustomFieldConfig, CustomFieldProps
â”‚       â”œâ”€â”€ shortcuts.ts   # SHORTCUTS constant for keyboard shortcuts
â”‚       â”‚
â”‚       â”œâ”€â”€ pages/         # Page components
â”‚       â”‚   â”œâ”€â”€ WriterDashboard.tsx  # Post list + AI generation
â”‚       â”‚   â”œâ”€â”€ EditorPage.tsx       # Tiptap editor + metadata
â”‚       â”‚   â””â”€â”€ SettingsPage.tsx     # Admin settings subpages
â”‚       â”‚
â”‚       â”œâ”€â”€ components/    # Shared components
â”‚       â”‚   â”œâ”€â”€ Navbar.tsx
â”‚       â”‚   â”œâ”€â”€ TiptapEditor.tsx
â”‚       â”‚   â”œâ”€â”€ EditorToolbar.tsx
â”‚       â”‚   â”œâ”€â”€ CommentsPanel.tsx
â”‚       â”‚   â”œâ”€â”€ CommentThread.tsx
â”‚       â”‚   â”œâ”€â”€ ChatPanel.tsx        # AI chat sidebar with mode selector
â”‚       â”‚   â”œâ”€â”€ ChatButton.tsx       # Floating chat toggle button
â”‚       â”‚   â”œâ”€â”€ TagsSection.tsx
â”‚       â”‚   â”œâ”€â”€ ModelSelector.tsx
â”‚       â”‚   â”œâ”€â”€ ControlButton.tsx
â”‚       â”‚   â”œâ”€â”€ RevisionHistoryDropdown.tsx
â”‚       â”‚   â”œâ”€â”€ Skeleton.tsx         # Reusable skeleton components
â”‚       â”‚   â”œâ”€â”€ Dropdown.tsx         # Reusable dropdown menu
â”‚       â”‚   â”œâ”€â”€ Form.tsx             # Form field components
â”‚       â”‚   â”œâ”€â”€ SettingsListPage.tsx # Generic admin list page
â”‚       â”‚   â”œâ”€â”€ ThemeProvider.tsx    # next-themes provider wrapper
â”‚       â”‚   â”œâ”€â”€ ThemeToggle.tsx      # Light/dark mode toggle
â”‚       â”‚   â”œâ”€â”€ GlobalShortcuts.tsx  # Global keyboard shortcuts
â”‚       â”‚   â”œâ”€â”€ Icons.tsx            # Custom icon components
â”‚       â”‚   â””â”€â”€ toolbar/
â”‚       â”‚       â”œâ”€â”€ index.ts
â”‚       â”‚       â”œâ”€â”€ ToolbarButton.tsx
â”‚       â”‚       â”œâ”€â”€ FormatButtons.tsx
â”‚       â”‚       â”œâ”€â”€ BlockButtons.tsx
â”‚       â”‚       â”œâ”€â”€ MediaButtons.tsx
â”‚       â”‚       â””â”€â”€ HistoryButtons.tsx
â”‚       â”‚
â”‚       â””â”€â”€ hooks/
â”‚           â”œâ”€â”€ useComments.ts    # Comment state + CRUD
â”‚           â”œâ”€â”€ useChat.tsx       # ChatProvider + useChatContext + modes
â”‚           â”œâ”€â”€ useAIModels.ts    # AI model fetching hook
â”‚           â””â”€â”€ useKeyboard.ts    # Keyboard shortcuts
â”‚
â”œâ”€â”€ prisma/
â”‚   â””â”€â”€ schema.prisma      # Reference schema for host apps
â”‚
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ tsup.config.ts         # Dual ESM/CJS build config
â””â”€â”€ package.json
```

## Database Schema

The package expects these Prisma models in the host app:

### Core Models

```prisma
model Post {
  id          String    @id @default(uuid())
  title       String
  subtitle    String?
  slug        String    @unique
  markdown    String
  status      String    @default("draft") // draft, published, suggested, deleted
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  // SEO fields
  seoTitle       String?
  seoDescription String?
  seoKeywords    String?
  noIndex        Boolean  @default(false)
  ogImage        String?

  // Preview
  previewToken  String?   @unique
  previewExpiry DateTime?

  // Relations
  revisions Revision[]
  tags      PostTag[]
  comments  Comment[]
  newsItem  NewsItem?

  // Auto-draft
  sourceUrl String?
  topicId   String?
  topic     TopicSubscription? @relation(...)
}

model Revision {
  id        String   @id @default(uuid())
  postId    String
  post      Post     @relation(...)
  title     String?
  subtitle  String?
  markdown  String
  createdAt DateTime @default(now())
}

model Comment {
  id         String    @id @default(uuid())
  postId     String
  post       Post      @relation(...)
  userId     String?
  user       User?     @relation(...)
  quotedText String    @default("")  // Highlighted text snapshot
  content    String
  parentId   String?                  // Single-level replies
  parent     Comment?  @relation("Replies", ...)
  replies    Comment[] @relation("Replies")
  resolved   Boolean   @default(false)
  deletedAt  DateTime?                // Soft delete
  approved   Boolean   @default(true) // Legacy for public comments
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}

model User {
  id        String    @id @default(uuid())
  email     String    @unique
  name      String?
  role      String    @default("writer") // admin, writer, drafter
  createdAt DateTime  @default(now())
  comments  Comment[]
}

model Tag {
  id        String    @id @default(uuid())
  name      String    @unique
  createdAt DateTime  @default(now())
  posts     PostTag[]
}

model PostTag {
  id        String   @id @default(uuid())
  postId    String
  tagId     String
  post      Post     @relation(...)
  tag       Tag      @relation(...)
  createdAt DateTime @default(now())
  @@unique([postId, tagId])
}
```

### AI & Integration Models

```prisma
model AISettings {
  id                   String   @id @default("default")
  rules                String   @default("")
  chatRules            String   @default("")
  rewriteRules         String?
  autoDraftRules       String?
  planRules            String?
  defaultModel         String   @default("claude-sonnet")
  autoDraftWordCount   Int      @default(800)
  generateTemplate     String?
  chatTemplate         String?
  rewriteTemplate      String?
  autoDraftTemplate    String?
  planTemplate         String?
  expandPlanTemplate   String?
  agentTemplate        String?  // Template for agent mode (direct editing)
  updatedAt            DateTime @updatedAt
}

model IntegrationSettings {
  id               String   @id @default("default")
  autoDraftEnabled Boolean  @default(false)
  updatedAt        DateTime @updatedAt
}

model TopicSubscription {
  id               String    @id @default(uuid())
  name             String
  keywords         String    // JSON array
  rssFeeds         String    // JSON array
  isActive         Boolean   @default(true)
  useKeywordFilter Boolean   @default(true)
  frequency        String    @default("daily")
  maxPerPeriod     Int       @default(3)
  essayFocus       String?
  lastRunAt        DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  posts            Post[]
  newsItems        NewsItem[]
}

model NewsItem {
  id          String            @id @default(uuid())
  topicId     String
  topic       TopicSubscription @relation(...)
  url         String            @unique
  title       String
  summary     String?
  publishedAt DateTime?
  status      String            @default("pending") // pending, generated, skipped
  postId      String?           @unique
  post        Post?             @relation(...)
  createdAt   DateTime          @default(now())
}
```

## Key Systems

### CLI Tool

The CLI (`npx autoblogger`) automates project setup:

```bash
npx autoblogger init          # Interactive setup
npx autoblogger init --yes    # Non-interactive with defaults
npx autoblogger import ./posts  # Import markdown content
```

**Init Process:**
1. Detect project (Next.js version, Prisma schema, Tailwind config)
2. Check for model name conflicts
3. Merge Prisma schema (adds 11 models)
4. Create boilerplate files (lib/cms.ts, API route, dashboard page)
5. Patch Tailwind config (v3 JS/TS or v4 CSS)
6. Run migration + generate
7. Optionally import existing content

**Files Created:**
- `lib/cms.ts` â€” CMS configuration
- `app/api/cms/[...path]/route.ts` â€” API catch-all route
- `app/writer/[[...path]]/page.tsx` â€” Dashboard page

### URL Content Extraction

The `url-extractor.ts` module fetches article content from URLs:

```typescript
import { extractAndFetchUrls, buildUrlContext } from './lib/url-extractor'

// Extract URLs from text and fetch their content
const fetched = await extractAndFetchUrls(userPrompt)
const context = buildUrlContext(fetched)  // XML format for AI prompts
```

**Features:**
- Detects URLs with/without protocol (`https://`, `www.`, bare domains)
- Uses Puppeteer for JS-rendered pages (auto-detects serverless vs local)
- Falls back to simple HTTP fetch + Mozilla Readability
- Limits content to ~4000 chars to avoid token bloat
- Returns title + cleaned text content

### Host App Integration

The package is mounted via catch-all routes in the host app:

```typescript
// app/api/cms/[...path]/route.ts
import { createAutoblogger, createAPIHandler } from 'autoblogger'
import { prisma } from '@/lib/db'
import { auth } from '@/lib/auth'

const cms = createAutoblogger({
  prisma,
  auth: {
    getSession: () => auth(),
    isAdmin: (session) => session?.user?.role === 'admin',
    canPublish: (session) => ['admin', 'writer'].includes(session?.user?.role),
  },
  ai: {
    anthropicKey: process.env.ANTHROPIC_API_KEY,
    openaiKey: process.env.OPENAI_API_KEY,
  },
})

const handler = createAPIHandler(cms, { basePath: '/api/cms' })

export { handler as GET, handler as POST, handler as PATCH, handler as DELETE }
```

```typescript
// app/(dashboard)/writer/[[...path]]/page.tsx
import { AutobloggerDashboard } from 'autoblogger/ui'

export default async function WriterPage({ params }) {
  const session = await auth()
  return (
    <AutobloggerDashboard
      apiBasePath="/api/cms"
      session={session}
      basePath="/writer"
    />
  )
}
```

### Navigation System

Internal SPA navigation via `DashboardContext`:
- `navigate(path)` â€” Push to history, update URL, render new page
- `goBack()` â€” Pop history or navigate to root
- `currentPath` â€” Current internal path
- History depth tracking for proper back button behavior

### Routes

| Path | Component | Description |
|------|-----------|-------------|
| `/` | WriterDashboard | Post list, AI generation, suggested posts |
| `/editor` | EditorPage | New post editor |
| `/editor/:slug` | EditorPage | Edit existing post |
| `/settings` | SettingsPage | Settings overview with counts |
| `/settings/users` | SettingsPage | User management |
| `/settings/ai` | SettingsPage | AI rules and templates |
| `/settings/tags` | SettingsPage | Tag management |
| `/settings/topics` | SettingsPage | RSS topic subscriptions |
| `/settings/posts` | SettingsPage | All posts admin view |
| `/settings/revisions` | SettingsPage | Revision history |
| `/settings/revisions/:id` | SettingsPage | Revision detail + restore |
| `/settings/comments` | SettingsPage | Comment moderation |

### AI Models

Defined in `src/ai/models.ts`:
```typescript
export const AI_MODELS: AIModel[] = [
  { id: 'claude-sonnet', name: 'Sonnet 4.5', provider: 'anthropic', modelId: 'claude-sonnet-4-5-20250929', searchModel: null },
  { id: 'claude-opus', name: 'Opus 4.5', provider: 'anthropic', modelId: 'claude-opus-4-5-20251101', searchModel: null },
  { id: 'gpt-5.2', name: 'GPT-5.2', provider: 'openai', modelId: 'gpt-5.2', searchModel: 'native' },
  { id: 'gpt-5-mini', name: 'GPT-5 Mini', provider: 'openai', modelId: 'gpt-5-mini', searchModel: 'native' },
]
```

`searchModel` property:
- `null` â€” Claude models use 2-call flow (search query first, then generate)
- `'native'` â€” GPT models use native tools-based web search

### Chat Modes

The chat system (`useChat.tsx`) supports multiple modes:
- `ask` â€” Default chat mode, answers questions about essay
- `agent` â€” Direct editing mode, AI outputs `:::edit` blocks with JSON commands
- `plan` â€” Outline mode, generates structured plan wrapped in `<plan>` tags
- `search` â€” Research mode, fact-finding without essay generation

Toggle modes via dropdown in ChatPanel or keyboard shortcut **Cmd/Ctrl + Shift + A**.

### Comments System

- **Inline comments**: Tiptap `CommentMark` extension highlights text
- **Panel**: `CommentsPanel` slides in from right (full-screen on mobile)
- **Thread**: `CommentThread` renders comment with nested replies
- **API**: `/posts/:id/comments` CRUD with resolve/unresolve
- **Deep linking**: `?comment=:id` URL param highlights and scrolls to comment

### Editor System

`EditorPage.tsx` provides:
- Tiptap WYSIWYG with markdown sync
- Markdown mode toggle (raw textarea)
- Auto-save drafts (3s debounce)
- Revision history with preview and restore
- AI generation from URL params (`?idea=...&model=...&length=...`)
- Inline comment highlighting
- Custom fields support via `fields` config
- SEO metadata editing

### AI Prompt Templates

Templates use `{{PLACEHOLDER}}` syntax. Defined in `src/ai/prompts.ts`:

| Template | Placeholders | Purpose |
|----------|--------------|---------|
| `DEFAULT_GENERATE_TEMPLATE` | `{{RULES}}`, `{{WORD_COUNT}}` | Essay generation |
| `DEFAULT_CHAT_TEMPLATE` | `{{CHAT_RULES}}`, `{{ESSAY_CONTEXT}}` | Chat conversations |
| `DEFAULT_REWRITE_TEMPLATE` | `{{REWRITE_RULES}}` | Text improvement |
| `DEFAULT_PLAN_TEMPLATE` | `{{PLAN_RULES}}`, `{{STYLE_EXAMPLES}}` | Outline generation |
| `DEFAULT_EXPAND_PLAN_TEMPLATE` | `{{RULES}}`, `{{STYLE_EXAMPLES}}`, `{{PLAN}}` | Plan to essay |
| `DEFAULT_AUTO_DRAFT_TEMPLATE` | `{{AUTO_DRAFT_RULES}}`, `{{RULES}}`, `{{AUTO_DRAFT_WORD_COUNT}}` | RSS auto-draft |
| `DEFAULT_AGENT_TEMPLATE` | (none, appended to chat) | Agent mode instructions |

Builders: `buildGeneratePrompt()`, `buildChatPrompt()`, `buildAgentChatPrompt()`, `buildPlanPrompt()`, `buildExpandPlanPrompt()`, `buildRewritePrompt()`, `buildAutoDraftPrompt()`

### Agent Mode (Direct Editing)

Agent mode allows AI to directly edit essays. Edit commands use JSON in `:::edit` blocks:

```
:::edit
{"type": "replace_section", "find": "exact text", "replace": "new text"}
:::
```

Command types:
- `replace_section` â€” Find and replace specific text
- `replace_all` â€” Replace entire essay (title, subtitle, markdown)
- `insert` â€” Insert text (position: before, after, start, end)
- `delete` â€” Remove text

Template is customizable via Settings â†’ AI â†’ Agent Mode Template.

Keyboard shortcut: **Cmd/Ctrl + Shift + A** toggles agent/ask mode.

### Chat History Persistence

Chat messages are persisted via `/api/cms/chat/history` API:
- `GET` â€” Fetch all messages
- `POST` â€” Save a new message

History is loaded on mount via `ChatProvider` and messages are saved after each exchange. The `ChatMessage` Prisma model stores role + content + timestamp.

## API Routes

| Path | Methods | Description |
|---|---|----|
| `/posts` | GET, POST | List/create posts |
| `/posts/:id` | GET, PATCH, DELETE | Single post CRUD |
| `/posts/:id/comments` | GET, POST | Editor comments for post |
| `/posts/:id/comments/:commentId` | PATCH, DELETE | Update/delete comment |
| `/posts/:id/comments/:commentId/resolve` | POST | Toggle resolve |
| `/posts/:id/comments/resolve-all` | POST | Resolve all open comments |
| `/revisions` | GET | List revisions (paginated) |
| `/revisions/:id` | GET, DELETE | Single revision |
| `/revisions/:id/restore` | POST | Restore revision |
| `/comments` | GET, POST | Admin comment listing |
| `/comments/:id/approve` | PATCH | Approve comment |
| `/tags` | GET, POST | List/create tags |
| `/tags/:id` | PATCH, DELETE | Update/delete tag |
| `/topics` | GET, POST | List/create topics |
| `/topics/:id` | GET, PATCH, DELETE | Single topic |
| `/topics/:id/generate` | POST | Trigger topic generation |
| `/users` | GET, POST | List/create users |
| `/users/:id` | GET, PATCH, DELETE | Single user |
| `/ai/settings` | GET, PATCH | AI configuration |
| `/ai/generate` | POST | Generate essay (streaming SSE) |
| `/ai/chat` | POST | Chat streaming (modes: ask, agent, plan, search) |
| `/chat/history` | GET, POST | Chat history persistence |
| `/settings` | GET, PATCH | Integration settings |
| `/upload` | POST | Image upload |
| `/admin/counts` | GET | Dashboard counts |

## Commands

### Development

| Command | Description |
|---|----|
| `npm run build` | Build package (ESM + CJS + types) |
| `npm run dev` | Watch mode for development |
| `npm run typecheck` | TypeScript check |
| `npm run lint` | ESLint check |

### CLI

| Command | Description |
|---|----|
| `npx autoblogger init` | Set up Autoblogger in a Next.js project |
| `npx autoblogger init --yes` | Non-interactive setup with defaults |
| `npx autoblogger init --dry-run` | Preview changes without writing |
| `npx autoblogger import <path>` | Import markdown/MDX content |
| `npx autoblogger import <path> --status=published` | Import as published |

## CI/CD

### GitHub Actions: Auto-publish to npm

Located at `.github/workflows/publish.yml`. Triggers on every push to `main`:

1. Checks out code and sets up Node.js 20
2. Installs dependencies and builds
3. **Auto-bumps patch version** if current version matches npm
4. Commits version bump and pushes
5. Publishes to npm
6. Skips version bump commits to prevent infinite loops

To release a new version:
1. Push changes to `main`
2. GitHub Actions automatically bumps version and publishes to npm

For manual version control (minor/major bumps):
1. Run `npm version minor` or `npm version major` locally
2. Commit and push â€” workflow will publish without bumping

## Build Output

```
dist/
â”œâ”€â”€ index.js          # CJS main entry
â”œâ”€â”€ index.mjs         # ESM main entry
â”œâ”€â”€ index.d.ts        # TypeScript declarations
â”œâ”€â”€ ui.js             # CJS UI components
â”œâ”€â”€ ui.mjs            # ESM UI components
â”œâ”€â”€ ui.d.ts           # UI declarations
â”œâ”€â”€ cli/
â”‚   â””â”€â”€ index.js      # CLI entry (npx autoblogger)
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ markdown.js/mjs/d.ts
â”‚   â””â”€â”€ seo.js/mjs/d.ts
â””â”€â”€ styles/
    â”œâ”€â”€ article.js/mjs
    â””â”€â”€ preset.js     # Tailwind preset (copied)
```

## Development Workflow

1. Make changes in `src/`
2. Run `npm run build` in autoblogger
3. Changes are immediately available in linked host apps
4. Test in host app's dev server
5. Commit with `d` for dev, `g` for production

### Local Linking

For local development, link autoblogger to host projects:

```bash
# In autoblogger directory (creates global symlink)
npm link

# In host project (e.g., sample-blog, blog)
npm link autoblogger
```

Linked projects:
- `/Users/hunter/Local Documents/Code/sample-blog` â€” Sample blog for testing
- `/Users/hunter/Local Documents/Code/blog` â€” Production blog

After making changes, run `npm run build` in autoblogger â€” changes are immediately reflected in linked projects via symlink.

**Note:** Running `npm install` in a linked project may break the link. Re-run `npm link autoblogger` to restore.
