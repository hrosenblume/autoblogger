# Project Context

> ⚠️ **THIS FILE IS COMMITTED TO GIT.** Do not add sensitive data: no emails, URLs, passwords, API keys, or secrets.

## Overview

**Autoblogger** — A reusable CMS package for Next.js applications. Provides a complete content management system with AI-powered writing, inline comments, revision history, and admin settings. Designed to be embedded in host Next.js apps via catch-all routes.

## Tech Stack

| Layer | Technology |
|----|---|
| Runtime | Node.js 20+ |
| Build | tsup (ESM + CJS dual output) |
| Database | Prisma (uses host app's client) |
| UI | React 18/19 |
| Styling | Tailwind CSS (via host app) |
| Editor | Tiptap WYSIWYG with markdown sync |
| AI | Anthropic SDK + OpenAI SDK |
| Markdown | marked + turndown |

## Package Exports

```typescript
// Server-side (API routes, data layer)
import { createAutoblogger, createAPIHandler } from 'autoblogger'

// Client-side (React dashboard)
import { AutobloggerDashboard } from 'autoblogger/ui'

// Utilities
import { renderMarkdown, htmlToMarkdown } from 'autoblogger/markdown'
import { ARTICLE_CLASSES } from 'autoblogger/styles/article'
import { getSeoValues } from 'autoblogger/seo'

// Comment utilities (for advanced integrations)
import { createCommentsClient, CommentMark } from 'autoblogger'
```

## Project Structure

```
autoblogger/
├── src/
│   ├── index.ts           # Main server exports: createAutoblogger(), utilities
│   ├── server.ts          # AutobloggerServer class factory
│   ├── config.ts          # Full config types (includes React types)
│   ├── schema.ts          # Prisma schema validation helper
│   ├── types.ts           # Core TypeScript types (Post, Revision, etc.)
│   │
│   ├── types/             # Consolidated type definitions
│   │   ├── index.ts       # Barrel exports
│   │   ├── models.ts      # Core model interfaces (Post, Comment, etc.)
│   │   ├── session.ts     # Session interface
│   │   ├── config.ts      # Config types + DEFAULT_STYLES
│   │   └── editor.ts      # Editor state types
│   │
│   ├── data/              # Prisma data layer
│   │   ├── index.ts       # Barrel exports
│   │   ├── factory.ts     # createCrudData() generic CRUD factory
│   │   ├── posts.ts       # Post CRUD + preview URLs
│   │   ├── revisions.ts   # Revision history + restore
│   │   ├── comments.ts    # Editor & public comments
│   │   ├── tags.ts        # Tag management + post relations
│   │   ├── topics.ts      # TopicSubscription CRUD
│   │   ├── news-items.ts  # RSS news item tracking
│   │   ├── users.ts       # User CRUD
│   │   └── ai-settings.ts # AI config singleton
│   │
│   ├── api/               # HTTP route handlers
│   │   ├── index.ts       # createAPIHandler() + route dispatcher
│   │   ├── utils.ts       # Shared: jsonResponse, parsePath, requireAdmin/Auth
│   │   ├── posts.ts       # /posts + /posts/:id/comments
│   │   ├── revisions.ts   # /revisions + restore
│   │   ├── comments.ts    # /comments (admin listing)
│   │   ├── tags.ts        # /tags CRUD
│   │   ├── topics.ts      # /topics + /topics/:id/generate
│   │   ├── users.ts       # /users CRUD (admin only)
│   │   ├── ai.ts          # /ai/settings, /ai/generate, /ai/chat
│   │   ├── settings.ts    # /settings (integration settings)
│   │   ├── upload.ts      # /upload (image upload)
│   │   └── admin.ts       # /admin/counts
│   │
│   ├── ai/                # AI integration
│   │   ├── index.ts       # Barrel exports
│   │   ├── models.ts      # AI_MODELS array (Claude, GPT)
│   │   ├── provider.ts    # Unified streaming abstraction
│   │   ├── generate.ts    # Essay generation
│   │   ├── chat.ts        # Chat streaming with modes
│   │   ├── prompts.ts     # Default prompt templates (all DEFAULT_* constants)
│   │   └── builders.ts    # buildGeneratePrompt, buildChatPrompt
│   │
│   ├── lib/               # Utilities
│   │   ├── cn.ts          # clsx + tailwind-merge
│   │   ├── format.ts      # formatDate, formatRelativeTime, countWords, truncate
│   │   ├── markdown.ts    # renderMarkdown, parseMarkdown, htmlToMarkdown
│   │   ├── markdown-helpers.ts # Cursor-based text manipulation for markdown mode
│   │   ├── seo.ts         # getSeoValues (title, description fallbacks)
│   │   ├── comments.ts    # createCommentsClient, permission helpers
│   │   ├── comment-mark.ts # Tiptap CommentMark extension
│   │   ├── editor-types.ts # RevisionState, AIState types
│   │   └── models.ts      # LENGTH_OPTIONS, AIModelOption type
│   │
│   ├── styles/            # Style exports
│   │   ├── article.ts     # ARTICLE_CLASSES, ARTICLE_LAYOUT
│   │   └── preset.js      # Tailwind preset (ab- prefixed tokens)
│   │
│   └── ui/                # React components
│       ├── index.ts       # UI barrel exports
│       ├── dashboard.tsx  # AutobloggerDashboard wrapper
│       ├── context.tsx    # DashboardProvider + hooks
│       ├── types.ts       # CustomFieldConfig, CustomFieldProps
│       │
│       ├── pages/         # Page components
│       │   ├── WriterDashboard.tsx  # Post list + AI generation
│       │   ├── EditorPage.tsx       # Tiptap editor + metadata
│       │   └── SettingsPage.tsx     # Admin settings subpages
│       │
│       ├── components/    # Shared components
│       │   ├── Navbar.tsx
│       │   ├── TiptapEditor.tsx
│       │   ├── EditorToolbar.tsx
│       │   ├── CommentsPanel.tsx
│       │   ├── CommentThread.tsx
│       │   ├── TagsSection.tsx
│       │   ├── ModelSelector.tsx
│       │   ├── ControlButton.tsx
│       │   ├── RevisionHistoryDropdown.tsx
│       │   ├── Skeleton.tsx         # Reusable skeleton components
│       │   ├── Dropdown.tsx         # Reusable dropdown menu
│       │   ├── Form.tsx             # Form field components
│       │   ├── SettingsListPage.tsx # Generic admin list page
│       │   └── toolbar/
│       │       ├── index.ts
│       │       ├── ToolbarButton.tsx
│       │       ├── FormatButtons.tsx
│       │       ├── BlockButtons.tsx
│       │       ├── MediaButtons.tsx
│       │       └── HistoryButtons.tsx
│       │
│       └── hooks/
│           ├── useComments.ts    # Comment state + CRUD
│           └── useKeyboard.ts    # Keyboard shortcuts
│
├── prisma/
│   └── schema.prisma      # Reference schema for host apps
│
├── tsconfig.json
├── tsup.config.ts         # Dual ESM/CJS build config
└── package.json
```

## Database Schema

The package expects these Prisma models in the host app:

### Core Models

```prisma
model Post {
  id          String    @id @default(uuid())
  title       String
  subtitle    String?
  slug        String    @unique
  markdown    String
  status      String    @default("draft") // draft, published, suggested, deleted
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  // SEO fields
  seoTitle       String?
  seoDescription String?
  seoKeywords    String?
  noIndex        Boolean  @default(false)
  ogImage        String?

  // Preview
  previewToken  String?   @unique
  previewExpiry DateTime?

  // Relations
  revisions Revision[]
  tags      PostTag[]
  comments  Comment[]
  newsItem  NewsItem?

  // Auto-draft
  sourceUrl String?
  topicId   String?
  topic     TopicSubscription? @relation(...)
}

model Revision {
  id        String   @id @default(uuid())
  postId    String
  post      Post     @relation(...)
  title     String?
  subtitle  String?
  markdown  String
  createdAt DateTime @default(now())
}

model Comment {
  id         String    @id @default(uuid())
  postId     String
  post       Post      @relation(...)
  userId     String?
  user       User?     @relation(...)
  quotedText String    @default("")  // Highlighted text snapshot
  content    String
  parentId   String?                  // Single-level replies
  parent     Comment?  @relation("Replies", ...)
  replies    Comment[] @relation("Replies")
  resolved   Boolean   @default(false)
  deletedAt  DateTime?                // Soft delete
  approved   Boolean   @default(true) // Legacy for public comments
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}

model User {
  id        String    @id @default(uuid())
  email     String    @unique
  name      String?
  role      String    @default("writer") // admin, writer, drafter
  createdAt DateTime  @default(now())
  comments  Comment[]
}

model Tag {
  id        String    @id @default(uuid())
  name      String    @unique
  createdAt DateTime  @default(now())
  posts     PostTag[]
}

model PostTag {
  id        String   @id @default(uuid())
  postId    String
  tagId     String
  post      Post     @relation(...)
  tag       Tag      @relation(...)
  createdAt DateTime @default(now())
  @@unique([postId, tagId])
}
```

### AI & Integration Models

```prisma
model AISettings {
  id                   String   @id @default("default")
  rules                String   @default("")
  chatRules            String   @default("")
  rewriteRules         String?
  autoDraftRules       String?
  planRules            String?
  defaultModel         String   @default("claude-sonnet")
  autoDraftWordCount   Int      @default(800)
  generateTemplate     String?
  chatTemplate         String?
  rewriteTemplate      String?
  autoDraftTemplate    String?
  planTemplate         String?
  expandPlanTemplate   String?
  updatedAt            DateTime @updatedAt
}

model IntegrationSettings {
  id               String   @id @default("default")
  autoDraftEnabled Boolean  @default(false)
  updatedAt        DateTime @updatedAt
}

model TopicSubscription {
  id               String    @id @default(uuid())
  name             String
  keywords         String    // JSON array
  rssFeeds         String    // JSON array
  isActive         Boolean   @default(true)
  useKeywordFilter Boolean   @default(true)
  frequency        String    @default("daily")
  maxPerPeriod     Int       @default(3)
  essayFocus       String?
  lastRunAt        DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  posts            Post[]
  newsItems        NewsItem[]
}

model NewsItem {
  id          String            @id @default(uuid())
  topicId     String
  topic       TopicSubscription @relation(...)
  url         String            @unique
  title       String
  summary     String?
  publishedAt DateTime?
  status      String            @default("pending") // pending, generated, skipped
  postId      String?           @unique
  post        Post?             @relation(...)
  createdAt   DateTime          @default(now())
}
```

## Key Systems

### Host App Integration

The package is mounted via catch-all routes in the host app:

```typescript
// app/api/cms/[...path]/route.ts
import { createAutoblogger, createAPIHandler } from 'autoblogger'
import { prisma } from '@/lib/db'
import { auth } from '@/lib/auth'

const cms = createAutoblogger({
  prisma,
  auth: {
    getSession: () => auth(),
    isAdmin: (session) => session?.user?.role === 'admin',
    canPublish: (session) => ['admin', 'writer'].includes(session?.user?.role),
  },
  ai: {
    anthropicKey: process.env.ANTHROPIC_API_KEY,
    openaiKey: process.env.OPENAI_API_KEY,
  },
})

const handler = createAPIHandler(cms, { basePath: '/api/cms' })

export { handler as GET, handler as POST, handler as PATCH, handler as DELETE }
```

```typescript
// app/(dashboard)/writer/[[...path]]/page.tsx
import { AutobloggerDashboard } from 'autoblogger/ui'

export default async function WriterPage({ params }) {
  const session = await auth()
  return (
    <AutobloggerDashboard
      apiBasePath="/api/cms"
      session={session}
      basePath="/writer"
    />
  )
}
```

### Navigation System

Internal SPA navigation via `DashboardContext`:
- `navigate(path)` — Push to history, update URL, render new page
- `goBack()` — Pop history or navigate to root
- `currentPath` — Current internal path
- History depth tracking for proper back button behavior

### Routes

| Path | Component | Description |
|------|-----------|-------------|
| `/` | WriterDashboard | Post list, AI generation, suggested posts |
| `/editor` | EditorPage | New post editor |
| `/editor/:slug` | EditorPage | Edit existing post |
| `/settings` | SettingsPage | Settings overview with counts |
| `/settings/users` | SettingsPage | User management |
| `/settings/ai` | SettingsPage | AI rules and templates |
| `/settings/tags` | SettingsPage | Tag management |
| `/settings/topics` | SettingsPage | RSS topic subscriptions |
| `/settings/posts` | SettingsPage | All posts admin view |
| `/settings/revisions` | SettingsPage | Revision history |
| `/settings/revisions/:id` | SettingsPage | Revision detail + restore |
| `/settings/comments` | SettingsPage | Comment moderation |

### AI Models

Defined in `src/ai/models.ts`:
```typescript
export const AI_MODELS = [
  { id: 'claude-sonnet', name: 'Sonnet 4.5', provider: 'anthropic', modelId: 'claude-sonnet-4-5-20250929' },
  { id: 'claude-opus', name: 'Opus 4.5', provider: 'anthropic', modelId: 'claude-opus-4-5-20251101' },
  { id: 'gpt-5.2', name: 'GPT-5.2', provider: 'openai', modelId: 'gpt-5.2' },
  { id: 'gpt-5-mini', name: 'GPT-5 Mini', provider: 'openai', modelId: 'gpt-5-mini' },
]
```

### Comments System

- **Inline comments**: Tiptap `CommentMark` extension highlights text
- **Panel**: `CommentsPanel` slides in from right (full-screen on mobile)
- **Thread**: `CommentThread` renders comment with nested replies
- **API**: `/posts/:id/comments` CRUD with resolve/unresolve
- **Deep linking**: `?comment=:id` URL param highlights and scrolls to comment

### Editor System

`EditorPage.tsx` provides:
- Tiptap WYSIWYG with markdown sync
- Markdown mode toggle (raw textarea)
- Auto-save drafts (3s debounce)
- Revision history with preview and restore
- AI generation from URL params (`?idea=...&model=...&length=...`)
- Inline comment highlighting
- Custom fields support via `fields` config
- SEO metadata editing

### AI Prompt Templates

Templates use `{{PLACEHOLDER}}` syntax:
- `{{RULES}}` — Essay writing rules from settings
- `{{CHAT_RULES}}` — Chat behavior rules
- `{{WORD_COUNT}}` — Target word count
- `{{ESSAY_CONTEXT}}` — Current essay content for chat
- `{{STYLE_EXAMPLES}}` — Example posts for style matching
- `{{PLAN}}` — Outline for expand_plan mode

## API Routes

| Path | Methods | Description |
|---|---|----|
| `/posts` | GET, POST | List/create posts |
| `/posts/:id` | GET, PATCH, DELETE | Single post CRUD |
| `/posts/:id/comments` | GET, POST | Editor comments for post |
| `/posts/:id/comments/:commentId` | PATCH, DELETE | Update/delete comment |
| `/posts/:id/comments/:commentId/resolve` | POST | Toggle resolve |
| `/posts/:id/comments/resolve-all` | POST | Resolve all open comments |
| `/revisions` | GET | List revisions (paginated) |
| `/revisions/:id` | GET, DELETE | Single revision |
| `/revisions/:id/restore` | POST | Restore revision |
| `/comments` | GET, POST | Admin comment listing |
| `/comments/:id/approve` | PATCH | Approve comment |
| `/tags` | GET, POST | List/create tags |
| `/tags/:id` | PATCH, DELETE | Update/delete tag |
| `/topics` | GET, POST | List/create topics |
| `/topics/:id` | GET, PATCH, DELETE | Single topic |
| `/topics/:id/generate` | POST | Trigger topic generation |
| `/users` | GET, POST | List/create users |
| `/users/:id` | GET, PATCH, DELETE | Single user |
| `/ai/settings` | GET, PATCH | AI configuration |
| `/ai/generate` | POST | Generate essay (streaming) |
| `/ai/chat` | POST | Chat streaming |
| `/settings` | GET, PATCH | Integration settings |
| `/upload` | POST | Image upload |
| `/admin/counts` | GET | Dashboard counts |

## Commands

| Command | Description |
|---|----|
| `npm run build` | Build package (ESM + CJS + types) |
| `npm run dev` | Watch mode for development |
| `npm run typecheck` | TypeScript check |
| `npm run lint` | ESLint check |

## CI/CD

### GitHub Actions: Auto-publish to npm

Located at `.github/workflows/publish.yml`. Triggers on every push to `main`:

1. Checks out code and sets up Node.js 20
2. Installs dependencies and builds
3. Compares current `package.json` version with published npm version
4. **Only publishes if version changed** — prevents duplicate publishes
5. Requires `NPM_TOKEN` secret configured in GitHub repo settings

To release a new version:
1. Bump version in `package.json`
2. Commit and push to `main`
3. GitHub Actions automatically publishes to npm

## Build Output

```
dist/
├── index.js          # CJS main entry
├── index.mjs         # ESM main entry
├── index.d.ts        # TypeScript declarations
├── ui.js             # CJS UI components
├── ui.mjs            # ESM UI components
├── ui.d.ts           # UI declarations
├── lib/
│   ├── markdown.js/mjs/d.ts
│   └── seo.js/mjs/d.ts
└── styles/
    ├── article.js/mjs
    └── preset.js     # Tailwind preset (copied)
```

## Development Workflow

1. Make changes in `src/`
2. Run `npm run build` in autoblogger
3. Changes are immediately available in linked host app
4. Test in host app's dev server
5. Commit with `d` for dev, `g` for production
