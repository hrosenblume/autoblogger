{"version":3,"sources":["../../src/lib/markdown.ts"],"sourcesContent":["import { marked, Renderer } from 'marked'\nimport TurndownService from 'turndown'\n\n// Configure marked for consistent rendering\nmarked.setOptions({\n  gfm: true,\n  breaks: false,\n})\n\n/**\n * Render markdown to HTML\n */\nexport function renderMarkdown(markdown: string): string {\n  return marked.parse(markdown) as string\n}\n\n/**\n * Convert markdown to HTML with GFM and line breaks enabled.\n * Safe for client-side use in components like ChatPanel.\n */\nexport function markdownToHtml(markdown: string): string {\n  return marked.parse(markdown, { gfm: true, breaks: true }) as string\n}\n\n/**\n * Custom renderer that adds Tailwind classes to HTML elements.\n * Used for rendering markdown in places where external CSS isn't loaded.\n */\nfunction createStyledRenderer(): Renderer {\n  const renderer = new Renderer()\n  \n  renderer.heading = function(this: Renderer, text: string, level: number): string {\n    const classes: Record<number, string> = {\n      1: 'text-[22px] leading-tight font-bold mb-4',\n      2: 'text-lg leading-snug font-bold mt-6 mb-3',\n      3: 'text-base leading-snug font-bold mt-4 mb-2',\n      4: 'text-sm leading-snug font-semibold mt-3 mb-1',\n      5: 'text-sm leading-snug font-semibold mt-2 mb-1',\n      6: 'text-sm leading-snug font-medium mt-2 mb-1',\n    }\n    return `<h${level} class=\"${classes[level] || ''}\">${text}</h${level}>\\n`\n  }\n  \n  renderer.paragraph = function(this: Renderer, text: string): string {\n    return `<p class=\"mb-3 leading-relaxed\">${text}</p>\\n`\n  }\n  \n  renderer.list = function(this: Renderer, body: string, ordered: boolean): string {\n    const tag = ordered ? 'ol' : 'ul'\n    const listClass = ordered ? 'list-decimal' : 'list-disc'\n    return `<${tag} class=\"${listClass} pl-5 mb-3 space-y-1\">${body}</${tag}>\\n`\n  }\n  \n  renderer.listitem = function(this: Renderer, text: string): string {\n    return `<li>${text}</li>\\n`\n  }\n  \n  renderer.code = function(this: Renderer, code: string, language: string | undefined): string {\n    const escaped = code.replace(/</g, '&lt;').replace(/>/g, '&gt;')\n    return `<pre class=\"bg-gray-100 dark:bg-gray-800 p-3 rounded-lg overflow-x-auto mb-3 text-sm font-mono\"><code class=\"language-${language || ''}\">${escaped}</code></pre>\\n`\n  }\n  \n  renderer.codespan = function(this: Renderer, text: string): string {\n    return `<code class=\"bg-gray-100 dark:bg-gray-800 px-1.5 py-0.5 rounded text-sm font-mono\">${text}</code>`\n  }\n  \n  renderer.blockquote = function(this: Renderer, quote: string): string {\n    return `<blockquote class=\"border-l-4 border-gray-300 dark:border-gray-600 pl-4 italic text-gray-600 dark:text-gray-400 my-3\">${quote}</blockquote>\\n`\n  }\n  \n  renderer.hr = function(this: Renderer): string {\n    return `<hr class=\"my-6 border-t border-gray-200 dark:border-gray-700\" />\\n`\n  }\n  \n  renderer.link = function(this: Renderer, href: string, _title: string | null, text: string): string {\n    return `<a href=\"${href}\" class=\"text-blue-600 dark:text-blue-400 underline\">${text}</a>`\n  }\n  \n  renderer.image = function(this: Renderer, href: string, _title: string | null, text: string): string {\n    return `<img src=\"${href}\" alt=\"${text}\" class=\"rounded-lg max-w-full my-3\" />`\n  }\n  \n  renderer.strong = function(this: Renderer, text: string): string {\n    return `<strong class=\"font-semibold\">${text}</strong>`\n  }\n  \n  renderer.em = function(this: Renderer, text: string): string {\n    return `<em class=\"italic\">${text}</em>`\n  }\n  \n  renderer.table = function(this: Renderer, header: string, body: string): string {\n    return `<table class=\"w-full border-collapse mb-3\"><thead>${header}</thead><tbody>${body}</tbody></table>\\n`\n  }\n  \n  renderer.tablerow = function(this: Renderer, content: string): string {\n    return `<tr>${content}</tr>\\n`\n  }\n  \n  renderer.tablecell = function(this: Renderer, content: string, flags: { header: boolean; align: string | null }): string {\n    const tag = flags.header ? 'th' : 'td'\n    const headerClass = flags.header ? ' font-semibold bg-gray-50 dark:bg-gray-800' : ''\n    const alignClass = flags.align ? ` text-${flags.align}` : ' text-left'\n    return `<${tag} class=\"border border-gray-200 dark:border-gray-700 px-3 py-2${alignClass}${headerClass}\">${content}</${tag}>`\n  }\n  \n  return renderer\n}\n\n// Create a single instance of the styled renderer\nconst styledRenderer = createStyledRenderer()\n\n/**\n * Convert markdown to HTML with inline Tailwind classes.\n * Use this for rendering in contexts where autoblogger.css isn't loaded.\n */\nexport function markdownToStyledHtml(markdown: string): string {\n  return marked.parse(markdown, { \n    gfm: true, \n    breaks: true,\n    renderer: styledRenderer,\n  }) as string\n}\n\n/**\n * Parse markdown to tokens (AST)\n */\nexport function parseMarkdown(markdown: string) {\n  return marked.lexer(markdown)\n}\n\n// Configure Turndown for HTML to markdown conversion\nconst turndownService = new TurndownService({\n  headingStyle: 'atx',\n  codeBlockStyle: 'fenced',\n  bulletListMarker: '-',\n})\n\n// Add strikethrough support (GFM extension)\nturndownService.addRule('strikethrough', {\n  filter: (node: HTMLElement) => {\n    const tagName = node.nodeName.toLowerCase()\n    return tagName === 'del' || tagName === 's' || tagName === 'strike'\n  },\n  replacement: (content) => `~~${content}~~`\n})\n\n/**\n * Convert HTML to markdown\n */\nexport function htmlToMarkdown(html: string): string {\n  return turndownService.turndown(html)\n}\n\n/**\n * Count words in text (markdown or plain text)\n */\nexport function wordCount(text: string): number {\n  if (!text) return 0\n  return text.trim().split(/\\s+/).filter(Boolean).length\n}\n\n/**\n * Generate URL-safe slug from title\n */\nexport function generateSlug(title: string): string {\n  return title\n    .toLowerCase()\n    .trim()\n    .replace(/[^\\w\\s-]/g, '')\n    .replace(/\\s+/g, '-')\n    .replace(/-+/g, '-')\n    .substring(0, 60)\n}\n\nimport sanitizeHtml from 'sanitize-html'\n\n/**\n * Render markdown to sanitized HTML.\n * Safe for public-facing pages where user content is displayed.\n */\nexport function renderMarkdownSanitized(markdown: string): string {\n  const html = renderMarkdown(markdown)\n  return sanitizeHtml(html, {\n    allowedTags: sanitizeHtml.defaults.allowedTags.concat(['img', 'h1', 'h2']),\n    allowedAttributes: {\n      ...sanitizeHtml.defaults.allowedAttributes,\n      img: ['src', 'alt', 'title'],\n      a: ['href', 'target', 'rel'],\n    },\n  })\n}\n"],"mappings":";AAAA,SAAS,QAAQ,gBAAgB;AACjC,OAAO,qBAAqB;AA6K5B,OAAO,kBAAkB;AA1KzB,OAAO,WAAW;AAAA,EAChB,KAAK;AAAA,EACL,QAAQ;AACV,CAAC;AAKM,SAAS,eAAe,UAA0B;AACvD,SAAO,OAAO,MAAM,QAAQ;AAC9B;AAMO,SAAS,eAAe,UAA0B;AACvD,SAAO,OAAO,MAAM,UAAU,EAAE,KAAK,MAAM,QAAQ,KAAK,CAAC;AAC3D;AAMA,SAAS,uBAAiC;AACxC,QAAM,WAAW,IAAI,SAAS;AAE9B,WAAS,UAAU,SAAyB,MAAc,OAAuB;AAC/E,UAAM,UAAkC;AAAA,MACtC,GAAG;AAAA,MACH,GAAG;AAAA,MACH,GAAG;AAAA,MACH,GAAG;AAAA,MACH,GAAG;AAAA,MACH,GAAG;AAAA,IACL;AACA,WAAO,KAAK,KAAK,WAAW,QAAQ,KAAK,KAAK,EAAE,KAAK,IAAI,MAAM,KAAK;AAAA;AAAA,EACtE;AAEA,WAAS,YAAY,SAAyB,MAAsB;AAClE,WAAO,mCAAmC,IAAI;AAAA;AAAA,EAChD;AAEA,WAAS,OAAO,SAAyB,MAAc,SAA0B;AAC/E,UAAM,MAAM,UAAU,OAAO;AAC7B,UAAM,YAAY,UAAU,iBAAiB;AAC7C,WAAO,IAAI,GAAG,WAAW,SAAS,yBAAyB,IAAI,KAAK,GAAG;AAAA;AAAA,EACzE;AAEA,WAAS,WAAW,SAAyB,MAAsB;AACjE,WAAO,OAAO,IAAI;AAAA;AAAA,EACpB;AAEA,WAAS,OAAO,SAAyB,MAAc,UAAsC;AAC3F,UAAM,UAAU,KAAK,QAAQ,MAAM,MAAM,EAAE,QAAQ,MAAM,MAAM;AAC/D,WAAO,yHAAyH,YAAY,EAAE,KAAK,OAAO;AAAA;AAAA,EAC5J;AAEA,WAAS,WAAW,SAAyB,MAAsB;AACjE,WAAO,sFAAsF,IAAI;AAAA,EACnG;AAEA,WAAS,aAAa,SAAyB,OAAuB;AACpE,WAAO,yHAAyH,KAAK;AAAA;AAAA,EACvI;AAEA,WAAS,KAAK,WAAiC;AAC7C,WAAO;AAAA;AAAA,EACT;AAEA,WAAS,OAAO,SAAyB,MAAc,QAAuB,MAAsB;AAClG,WAAO,YAAY,IAAI,wDAAwD,IAAI;AAAA,EACrF;AAEA,WAAS,QAAQ,SAAyB,MAAc,QAAuB,MAAsB;AACnG,WAAO,aAAa,IAAI,UAAU,IAAI;AAAA,EACxC;AAEA,WAAS,SAAS,SAAyB,MAAsB;AAC/D,WAAO,iCAAiC,IAAI;AAAA,EAC9C;AAEA,WAAS,KAAK,SAAyB,MAAsB;AAC3D,WAAO,sBAAsB,IAAI;AAAA,EACnC;AAEA,WAAS,QAAQ,SAAyB,QAAgB,MAAsB;AAC9E,WAAO,qDAAqD,MAAM,kBAAkB,IAAI;AAAA;AAAA,EAC1F;AAEA,WAAS,WAAW,SAAyB,SAAyB;AACpE,WAAO,OAAO,OAAO;AAAA;AAAA,EACvB;AAEA,WAAS,YAAY,SAAyB,SAAiB,OAA0D;AACvH,UAAM,MAAM,MAAM,SAAS,OAAO;AAClC,UAAM,cAAc,MAAM,SAAS,+CAA+C;AAClF,UAAM,aAAa,MAAM,QAAQ,SAAS,MAAM,KAAK,KAAK;AAC1D,WAAO,IAAI,GAAG,gEAAgE,UAAU,GAAG,WAAW,KAAK,OAAO,KAAK,GAAG;AAAA,EAC5H;AAEA,SAAO;AACT;AAGA,IAAM,iBAAiB,qBAAqB;AAMrC,SAAS,qBAAqB,UAA0B;AAC7D,SAAO,OAAO,MAAM,UAAU;AAAA,IAC5B,KAAK;AAAA,IACL,QAAQ;AAAA,IACR,UAAU;AAAA,EACZ,CAAC;AACH;AAKO,SAAS,cAAc,UAAkB;AAC9C,SAAO,OAAO,MAAM,QAAQ;AAC9B;AAGA,IAAM,kBAAkB,IAAI,gBAAgB;AAAA,EAC1C,cAAc;AAAA,EACd,gBAAgB;AAAA,EAChB,kBAAkB;AACpB,CAAC;AAGD,gBAAgB,QAAQ,iBAAiB;AAAA,EACvC,QAAQ,CAAC,SAAsB;AAC7B,UAAM,UAAU,KAAK,SAAS,YAAY;AAC1C,WAAO,YAAY,SAAS,YAAY,OAAO,YAAY;AAAA,EAC7D;AAAA,EACA,aAAa,CAAC,YAAY,KAAK,OAAO;AACxC,CAAC;AAKM,SAAS,eAAe,MAAsB;AACnD,SAAO,gBAAgB,SAAS,IAAI;AACtC;AAKO,SAAS,UAAU,MAAsB;AAC9C,MAAI,CAAC,KAAM,QAAO;AAClB,SAAO,KAAK,KAAK,EAAE,MAAM,KAAK,EAAE,OAAO,OAAO,EAAE;AAClD;AAKO,SAAS,aAAa,OAAuB;AAClD,SAAO,MACJ,YAAY,EACZ,KAAK,EACL,QAAQ,aAAa,EAAE,EACvB,QAAQ,QAAQ,GAAG,EACnB,QAAQ,OAAO,GAAG,EAClB,UAAU,GAAG,EAAE;AACpB;AAQO,SAAS,wBAAwB,UAA0B;AAChE,QAAM,OAAO,eAAe,QAAQ;AACpC,SAAO,aAAa,MAAM;AAAA,IACxB,aAAa,aAAa,SAAS,YAAY,OAAO,CAAC,OAAO,MAAM,IAAI,CAAC;AAAA,IACzE,mBAAmB;AAAA,MACjB,GAAG,aAAa,SAAS;AAAA,MACzB,KAAK,CAAC,OAAO,OAAO,OAAO;AAAA,MAC3B,GAAG,CAAC,QAAQ,UAAU,KAAK;AAAA,IAC7B;AAAA,EACF,CAAC;AACH;","names":[]}